# –¢–µ—Å—Ç —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –±–∏–∑–Ω–µ—Å–∞–º

**–î–∞—Ç–∞:** 24.01.2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ  
**–§–∞–π–ª—ã:** AR/Invoices/Index.razor, AG/Quotes/Index.razor

---

## üéØ –¶–µ–ª—å —Ç–µ—Å—Ç–∞
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–∏ —Å–º–µ–Ω–µ –±–∏–∑–Ω–µ—Å–∞ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ (header) –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.

---

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### 1. BusinessContext.cs
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/QIMy.Web/Services/BusinessContext.cs`

**–ö–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:**
```csharp
public class BusinessContext
{
    public int? CurrentBusinessId { get; private set; }
    public event Action? Changed;  // ‚¨ÖÔ∏è –°–æ–±—ã—Ç–∏–µ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
    
    public async Task SetBusinessAsync(int businessId, bool saveDefault = true)
    {
        CurrentBusinessId = businessId;
        Changed?.Invoke();  // ‚¨ÖÔ∏è –¢—Ä–∏–≥–≥–µ—Ä —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ –±–∏–∑–Ω–µ—Å–∞
    }
}
```

### 2. AR/Invoices/Index.razor
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/QIMy.Web/Components/Pages/AR/Invoices/Index.razor`

**–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ:**
```csharp
@code {
    protected override async Task OnInitializedAsync()
    {
        await BusinessCtx.InitializeAsync();
        
        // –ü–æ–¥–ø–∏—Å–∫–∞ —Å async lambda
        BusinessCtx.Changed += async () => 
        {
            await LoadInvoices();  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            StateHasChanged();     // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        };
        
        await LoadInvoices();
    }
    
    private async Task LoadInvoices()
    {
        var all = (await InvoiceService.GetAllInvoicesAsync()).ToList();
        var bizId = BusinessCtx.CurrentBusinessId;
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–µ–∫—É—â–µ–º—É –±–∏–∑–Ω–µ—Å—É
        invoices = bizId.HasValue 
            ? all.Where(i => i.BusinessId == bizId.Value).ToList() 
            : all;
    }
}
```

### 3. AG/Quotes/Index.razor
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/QIMy.Web/Components/Pages/AG/Quotes/Index.razor`

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```csharp
@code {
    protected override async Task OnInitializedAsync()
    {
        await BusinessCtx.InitializeAsync();
        
        BusinessCtx.Changed += async () =>
        {
            await LoadQuotes();
            StateHasChanged();
        };
        
        await LoadQuotes();
    }
    
    private async Task LoadQuotes()
    {
        var all = (await QuoteService.GetAllQuotesAsync()).ToList();
        var bizId = BusinessCtx.CurrentBusinessId;
        
        quotes = bizId.HasValue 
            ? all.Where(q => q.BusinessId == bizId.Value).ToList() 
            : all;
    }
}
```

---

## üìã –ü–ª–∞–Ω —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:
1. ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ: `dotnet run --project src/QIMy.Web/QIMy.Web.csproj --urls "http://localhost:5204"`
2. ‚úÖ –í –ë–î –µ—Å—Ç—å –º–∏–Ω–∏–º—É–º 2 –±–∏–∑–Ω–µ—Å–∞
3. ‚úÖ –í –ë–î –µ—Å—Ç—å —Å—á–µ—Ç–∞ (Invoices) —Å —Ä–∞–∑–Ω—ã–º–∏ BusinessId
4. ‚úÖ –í –ë–î –µ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (Quotes) —Å —Ä–∞–∑–Ω—ã–º–∏ BusinessId
5. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω (admin/Admin123!)

### –®–∞–≥–∏ —Ç–µ—Å—Ç–∞:

#### –¢–µ—Å—Ç 1: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å—á–µ—Ç–æ–≤ (Invoices)
1. –û—Ç–∫—Ä—ã—Ç—å: http://localhost:5204/ar/invoices
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π –±–∏–∑–Ω–µ—Å –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ (header, –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª)
3. –ó–∞–ø–∏—Å–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —Å—á–µ—Ç–æ–≤: _____ —à—Ç—É–∫
4. –°–º–µ–Ω–∏—Ç—å –±–∏–∑–Ω–µ—Å —á–µ—Ä–µ–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä
5. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** 
   - ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ù–ï –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
   - ‚úÖ –°–ø–∏—Å–æ–∫ —Å—á–µ—Ç–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—á–µ—Ç–∞ —Å –Ω–æ–≤—ã–º BusinessId
6. –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–µ—Ä–≤–æ–º—É –±–∏–∑–Ω–µ—Å—É
7. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –°–ø–∏—Å–æ–∫ –≤–µ—Ä–Ω—É–ª—Å—è –∫ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é

#### –¢–µ—Å—Ç 2: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (Quotes)
1. –û—Ç–∫—Ä—ã—Ç—å: http://localhost:5204/ag/quotes
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π –±–∏–∑–Ω–µ—Å
3. –ó–∞–ø–∏—Å–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: _____ —à—Ç—É–∫
4. –°–º–µ–Ω–∏—Ç—å –±–∏–∑–Ω–µ—Å
5. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞
   - ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ BusinessId —Ä–∞–±–æ—Ç–∞–µ—Ç
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É 2-3 –±–∏–∑–Ω–µ—Å–∞–º–∏
7. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –±–∏–∑–Ω–µ—Å—É

#### –¢–µ—Å—Ç 3: –ö—Ä–æ—Å—Å-—Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
1. –û—Ç–∫—Ä—ã—Ç—å: http://localhost:5204/ar/invoices
2. –°–º–µ–Ω–∏—Ç—å –±–∏–∑–Ω–µ—Å –Ω–∞ "–ë–∏–∑–Ω–µ—Å A"
3. –û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ: http://localhost:5204/ag/quotes
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –í –æ–±–µ–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –±–∏–∑–Ω–µ—Å
   - ‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç "–ë–∏–∑–Ω–µ—Å—É A"
5. –í –ø–µ—Ä–≤–æ–π –≤–∫–ª–∞–¥–∫–µ —Å–º–µ–Ω–∏—Ç—å –±–∏–∑–Ω–µ—Å –Ω–∞ "–ë–∏–∑–Ω–µ—Å B"
6. –ü–µ—Ä–µ–π—Ç–∏ –≤–æ –≤—Ç–æ—Ä—É—é –≤–∫–ª–∞–¥–∫—É –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)
7. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –í—Ç–æ—Ä–∞—è –≤–∫–ª–∞–¥–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ë–∏–∑–Ω–µ—Å B"

#### –¢–µ—Å—Ç 4: –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ 1 –±–∏–∑–Ω–µ—Å
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å–ª–∏ BusinessId = null (–ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å–ª–∏ —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞ 0 —Å—á–µ—Ç–æ–≤
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "No invoices found"

---

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û (24.01.2026)
**–ü—Ä–æ–±–ª–µ–º–∞:** CS0407 "–∏–º–µ–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π —Ç–∏–ø"
- `BusinessContext.Changed` ‚Äî —Å–æ–±—ã—Ç–∏–µ —Ç–∏–ø–∞ `Action` (void)
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±—ã–ª–∏ `async Task`, —á—Ç–æ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ async lambda:
```csharp
// ‚ùå –ë–´–õ–û (–æ—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏):
BusinessCtx.Changed += OnBusinessChanged;
private async Task OnBusinessChanged() { ... }

// ‚úÖ –°–¢–ê–õ–û:
BusinessCtx.Changed += async () => 
{
    await LoadData();
    StateHasChanged();
};
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

| –¢–µ—Å—Ç | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|--------|------------|
| –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ | ‚úÖ PASS | 0 –æ—à–∏–±–æ–∫, 0 –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π |
| –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | ‚úÖ PASS | http://localhost:5204 —Ä–∞–±–æ—Ç–∞–µ—Ç |
| –ó–∞–≥—Ä—É–∑–∫–∞ /ar/invoices | ‚úÖ PASS | 200 OK, 575ms |
| –ó–∞–≥—Ä—É–∑–∫–∞ /ag/quotes | ‚è≥ TODO | –ù—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ UI |
| –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ | ‚è≥ TODO | –ù—É–∂–µ–Ω —Ä—É—á–Ω–æ–π —Ç–µ—Å—Ç |
| –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö | ‚è≥ TODO | –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î |

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –†–∞—Å—à–∏—Ä–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–æ—Ç –∂–µ –ø–∞—Ç—Ç–µ—Ä–Ω –∫:
- [ ] AR/Clients/Index.razor (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å BusinessId –≤ Client)
- [ ] Products/Index.razor (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å BusinessId –≤ Product)
- [ ] TaxRates/Index.razor
- [ ] Units/Index.razor
- [ ] Accounts/Index.razor

### 2. –î–æ–±–∞–≤–∏—Ç—å BusinessId –≤ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏
**–¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è –ë–î –¥–ª—è:**
- Client (—Å–µ–π—á–∞—Å –Ω–µ—Ç BusinessId)
- Product (—Å–µ–π—á–∞—Å –Ω–µ—Ç BusinessId)
- Supplier (—Å–µ–π—á–∞—Å –Ω–µ—Ç BusinessId)

**–ú–∏–≥—Ä–∞—Ü–∏—è:**
```csharp
public class AddBusinessIdToClientAndProduct : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.AddColumn<int>(
            name: "BusinessId",
            table: "Clients",
            nullable: false,
            defaultValue: 1);
            
        migrationBuilder.AddColumn<int>(
            name: "BusinessId",
            table: "Products",
            nullable: false,
            defaultValue: 1);
            
        migrationBuilder.CreateIndex(
            name: "IX_Clients_BusinessId",
            table: "Clients",
            column: "BusinessId");
            
        migrationBuilder.CreateIndex(
            name: "IX_Products_BusinessId",
            table: "Products",
            column: "BusinessId");
    }
}
```

### 3. –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã
–°–æ–∑–¥–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è BusinessContext:
- –¢–µ—Å—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ Changed
- –¢–µ—Å—Ç SetBusinessAsync —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç Changed
- –¢–µ—Å—Ç InitializeAsync —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–µ—Ä–≤—ã–π –±–∏–∑–Ω–µ—Å

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–†–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é.**

–ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ CS0407
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–∞—Ç—Ç–µ—Ä–Ω –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ async lambda
- ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ 2 —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º (Invoices, Quotes)
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ BusinessId —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ StateHasChanged() –æ–±–Ω–æ–≤–ª—è–µ—Ç UI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

–¢—Ä–µ–±—É–µ—Ç—Å—è:
- ‚è≥ –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ UI (—Å–º–µ–Ω–∞ –±–∏–∑–Ω–µ—Å–∞ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)
- ‚è≥ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- ‚è≥ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ BusinessId –≤ Client/Product
