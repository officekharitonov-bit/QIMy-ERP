PERSONEN INDEX.XLSX - СТРУКТУРА И СВЯЗИ
=========================================

📋 ЛИСТ 1: "Personen Index" (ГЛАВНЫЙ ЛИСТ)
─────────────────────────────────────────
Назначение: Основной лист для работы с данными клиентов (Personenkonten)
Структура: 22 столбца (как указано в импорте клиентов)
Содержит: Формулы, ссылающиеся на справочники других листов

Связи с другими листами:
├─ Sheet 2 (EU-RATE) → для поиска налоговых ставок по странам
├─ Sheet 3 (CODE_INDEX) → для кодов счетов (Erlöskonten)
├─ Sheet 4 (Steuercodes) → для налоговых кодов и автоматизации
├─ Sheet 5 (Sorted list) → для соответствия Kto-Nr ↔ Country codes
└─ Sheet 6 (Länder) → для справочника стран


📊 ЛИСТ 2: "EU-RATE" (СПРАВОЧНИК СТРАН ЕС)
──────────────────────────────────────────
Назначение: VAT ставки и данные по странам ЕС (27 стран)
Ключевые поля:
  • Code (Col 2)              → ISO 2-буквенный код страны (AT, DE, BE...)
  • Standard Rate (Col 3)     → Стандартная ставка НДС (%)
  • LAND (Col 4)              → Немецкое название страны
  • Erwerbsschwelle (Col 5)   → Порог закупки (тысячи валюты)
  • Lieferschwelle (Col 6)    → Порог поставок (тысячи валюты)
  • WAE (Col 7)               → Валюта страны (EUR, BGN, HRK...)
  • Kto-Nr (Col 8)            → Номер счета (4000, 4001, 4002...)
  • Land-NR (Col 10)          → Номер страны (1, 4, 24, 28, 246...)

Пример (Австрия):
  AT | 20% | Österreich | 11000 | 35000 | EUR | 4000 | 1

Использование: Поиск by Code → получить ставку НДС, валюту, пороги


🔢 ЛИСТ 3: "CODE_INDEX" (ИНДЕКС КОДОВ СЧЕТОВ)
─────────────────────────────────────────────
Назначение: Справочник бухгалтерских счетов (Erlöskonten) с привязкой к странам
Структура сложная (не совсем понятна):
  • Row 1: Headers (Kto-Nr | Bezeichnung | Fogalom | Kontoart | сode | USt-Pz)
  • Row 2 onwards: Данные со ссылками на страны

Ключевые поля:
  • Kto-Nr (Col 1)            → Номер счета
  • Bezeichnung (Col 2)       → Описание на немецком
  • Kontoart (Col 4)          → Тип счета (Ertrag = Доход)
  • сode (Col 5)              → Код (77, 1, 20...)

Пример:
  4211 | Erlöse EU-HU-MOSS | Ertrag | 1 | 27 | Belgien | 11.200 EUR | 35.000 EUR

Использование: Поиск по Kto-Nr → получить тип, код, описание


📝 ЛИСТ 4: "Steuercodes" (НАЛОГОВЫЕ КОДЫ И АВТОМАТИЗАЦИЯ)
──────────────────────────────────────────────────────────
Назначение: Справочник налоговых кодов, способ учета, автоматизация
Объём: 1038 строк

Ключевые поля:
  • Kto-Nr (Col 1)            → Номер счета (100, 109, 110...)
  • Bezeichnung (Col 2)       → Описание на немецком
  • Kontoart (Col 3)          → Тип счета (Aktiv, Passiv, Ertrag...)
  • code (Col 4)              → Код учета
  • P-Kz (Col 5)              → Признак (?)
  • USt-Pz (Col 6)            → Tax code (код НДС)
  • Automatik (Col 7)         → Автоматический учет
  • A (Col 8)                 → Флаг (A/[empty])
  • Texte (Col 9)             → Текст на немецком
  • перевод Google (Col 10)   → Русский перевод

Пример:
  110 | Patentrechte | Aktiv | [empty] | [empty] | [empty] | [empty] | A | [empty] | Патентные права

Использование: Поиск по Kto-Nr → получить налоговый код, тип, описание


📋 ЛИСТ 5: "Sorted list" (СОРТИРОВАННЫЙ СПИСОК)
─────────────────────────────────────────────────
Назначение: Связь между номерами счетов (Kto-Nr) и кодами стран (Freifeld 01)
Объём: 1000 строк

Ключевые поля:
  • Kto-Nr (Col 1)            → Номер счета (200000, 200001...)
  • Freifeld 01 (Col 2)       → Код страны для этого счета (AT, DE, BE, FI...)
  • Nachname (Col 3)          → Описание (Barverkaufe AUSTRIA...)

Пример:
  200000 | AT | Barverkaufe AUSTRIA - Selbstausfuhr (EU)
  200001 | DE | Barverkaufe DEUTSCHLAND - 100.000 Lieferschwelle
  200002 | BE | Barverkaufe BELGIEN - NETTO 35.000 Lieferschwelle

Использование: Поиск по Kto-Nr → узнать для какой страны этот счет


🌍 ЛИСТ 6: "Länder" (СПРАВОЧНИК СТРАН)
─────────────────────────────────────────
Назначение: Основные данные стран (немецкое название, английское, номер)
Объём: ~30 стран

Ключевые поля:
  • Col 1: Deutscher Name      → Страна на немецком (Österreich, Deutschland...)
  • Col 2: Account range?      → Числовой код (34700, 21186...)
  • Col 3: English Name        → Страна на английском (Austria, Germany...)
  • Col 4: Land-NR (Country#)  → Номер страны (1, 2, 3, 4...)

Пример:
  Österreich | 34700 | Austria | 1
  Deutschland | 21186 | Germany | 2
  Italien | 21186 | Italy | 3

Использование: Поиск по названию или номеру → получить английское имя и номер


🔗 ЛОГИКА СВЯЗЕЙ (ДЛЯ ФОРМУЛ)
════════════════════════════════════════════════════════════════

СЦЕНАРИЙ 1: Найти ставку НДС по коду страны
─────────────────────────────────────────────
1. Пользователь вводит: Code = "DE" (Германия)
2. Ищем в EU-RATE (Sheet 2) по Col 2 (Code) → находим строку с DE
3. Берём из той же строки: Standard Rate (Col 3) = 19%

Формула: =VLOOKUP("DE", EU-RATE!A:M, 3, FALSE)


СЦЕНАРИЙ 2: Найти валюту и пороги по стране
──────────────────────────────────────────────
1. Пользователь вводит: Страна = "Austria" (Code = "AT")
2. Ищем в EU-RATE по Code = "AT"
3. Берём: WAE (Col 7) = EUR, Erwerbsschwelle (Col 5) = 11000, Lieferschwelle (Col 6) = 35000

Формула: =VLOOKUP("AT", EU-RATE!A:M, 7, FALSE)  [для валюты]


СЦЕНАРИЙ 3: Найти налоговый код по номеру счета
─────────────────────────────────────────────────
1. Пользователь вводит: Kto-Nr = 4211
2. Ищем в CODE_INDEX или Steuercodes по Col 1 (Kto-Nr) = 4211
3. Берём: code (Col 4-5), описание, налоговый код

Формула: =VLOOKUP(4211, Steuercodes!A:L, 6, FALSE)  [для USt-Pz]


СЦЕНАРИЙ 4: Проверить, для какой страны счет (Kto-Nr)
────────────────────────────────────────────────────────
1. Пользователь вводит: Kto-Nr = 200002
2. Ищем в "Sorted list" (Sheet 5) по Col 1 = 200002
3. Берём: Freifeld 01 (Col 2) = "BE" (Belgien)
4. Далее можем найти полные данные Belgien в EU-RATE или Länder

Формула: =VLOOKUP(200002, "Sorted list"!A:C, 2, FALSE)


📌 ВАЖНЫЕ ПОЛЯ ДЛЯ ИМПОРТА КЛИЕНТОВ
════════════════════════════════════════════════════════════════

На основе скриншотов 22-колоночного импорта и таблиц выше:

1. Freifeld 01 (Externe KontoNr)   → Код страны (AT, DE, BE...) из EU-RATE!Code
   Пример: "AT" → ищем в EU-RATE, получаем все данные Австрии

2. Erlöskonten (Account Number)     → Из CODE_INDEX или Steuercodes (Kto-Nr)
   Пример: 4000 (расчётный счет) или 4113 (доходы)

3. Currency (Валюта)                → Из EU-RATE!WAE по коду страны
   Пример: EUR, BGN, HRK...

4. Payment Terms (Дни оплаты)       → Из дополнительных полей или фиксированное значение
   
5. VAT Rate                         → Из EU-RATE!Standard Rate по коду страны
   Пример: 20%, 21%, 19%...

6. Thresholds                       → Из EU-RATE (Erwerbsschwelle, Lieferschwelle)
   Пример: Австрия 11000 EUR закупка, 35000 EUR поставка


✨ ВЫВОД
════════════════════════════════════════════════════════════════

Personen Index.xlsx — это комплексная система справочников для управления:
  ✓ Налоговыми ставками по странам ЕС
  ✓ Бухгалтерскими счетами (Erlöskonten, Steuercodes)
  ✓ Валютами и пороговыми значениями по странам
  ✓ Связями между номерами счетов и странами

При импорте клиентов:
  → Каждый клиент связан с кодом страны (Freifeld 01)
  → По коду страны ищем в EU-RATE все параметры (валюта, ставка, пороги)
  → По номеру счета ищем в Steuercodes налоговый код и описание
  → Все связи реализуются через VLOOKUP/INDEX-MATCH формулы в Excel

Для интеграции в QIMy нужно:
  1. Загрузить эти справочники в базу данных
  2. Создать таблицы: Countries, VATRates, AccountCodes, TaxCodes
  3. Переписать формулы импорта на T-SQL JOIN вместо Excel VLOOKUP
