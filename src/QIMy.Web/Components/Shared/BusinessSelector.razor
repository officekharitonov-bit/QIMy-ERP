@using QIMy.Web.Services
@inject BusinessContext BusinessCtx
@inject NavigationManager Nav
@rendermode InteractiveServer
@implements IDisposable

<div class="d-flex align-items-center gap-2">
    <span class="text-muted small">Фирма:</span>
    <select class="form-select form-select-sm" style="min-width: 240px;" @onchange="OnBusinessChanged" value="@selectedId">
        @if (businesses?.Count > 0)
        {
            @foreach (var b in businesses)
            {
                <option value="@b.Id">@b.Name</option>
            }
        }
        else
        {
            <option disabled selected>Нет доступных фирм</option>
        }
    </select>

    <a class="btn btn-sm btn-outline-secondary" href="@SettingsLink">
        <i class="bi bi-gear"></i>
    </a>
</div>

@code {
    private List<Business> businesses = new();
    private int? selectedId;

    protected override async Task OnInitializedAsync()
    {
        await BusinessCtx.InitializeAsync();
        businesses = await BusinessCtx.GetUserBusinessesAsync();
        selectedId = BusinessCtx.CurrentBusinessId ?? (businesses.Count > 0 ? businesses[0].Id : (int?)null);
        
        // Subscribe to business changes from other components
        BusinessCtx.Changed += OnBusinessContextChanged;
    }

    private void OnBusinessContextChanged()
    {
        selectedId = BusinessCtx.CurrentBusinessId;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        BusinessCtx.Changed -= OnBusinessContextChanged;
    }

    private async Task OnBusinessChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e?.Value?.ToString(), out var id))
        {
            selectedId = id;
            await BusinessCtx.SetBusinessAsync(id);
            
            // Force page reload to clear all cached data
            Nav.NavigateTo(Nav.Uri, forceLoad: true);
        }
    }

    private string SettingsLink => selectedId.HasValue
        ? $"/admin/businesses/edit/{selectedId.Value}"
        : "/admin/businesses";
}
