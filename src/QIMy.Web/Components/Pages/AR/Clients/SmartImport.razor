@rendermode InteractiveServer
@page "/AR/Clients/SmartImport"
@using QIMy.Core.DTOs
@using QIMy.Infrastructure.Services
@using Microsoft.AspNetCore.Components.Forms
@using QIMy.Web.Components.Shared
@inject ClientImportService ImportService
@inject NavigationManager NavigationManager
@inject ILogger<SmartImport> Logger

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-magic me-2"></i>Smart Import - –£–º–Ω—ã–π –∏–º–ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/AR/Clients">Clients</a></li>
                    <li class="breadcrumb-item active">Smart Import</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Step 1: File Upload -->
    @if (currentStep == ImportStep.FileSelection)
    {
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">–®–∞–≥ 1: –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-lightbulb me-2"></i>
                            <strong>–£–º–Ω—ã–π –∏–º–ø–æ—Ä—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:</strong>
                            <ul class="mb-0">
                                <li>–û–ø—Ä–µ–¥–µ–ª–∏—Ç —Ñ–æ—Ä–º–∞—Ç –≤–∞—à–µ–≥–æ CSV —Ñ–∞–π–ª–∞ (QIMy, BMD, –∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π)</li>
                                <li>–ü–æ–∫–∞–∂–µ—Ç –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö</li>
                                <li>–ü–æ–∑–≤–æ–ª–∏—Ç –≤—Ä—É—á–Ω—É—é —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏</li>
                                <li>–°–æ—Ö—Ä–∞–Ω–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</li>
                            </ul>
                        </div>

                        <InputFile OnChange="HandleFileSelection" class="form-control mb-3" accept=".csv" />

                        @if (selectedFileName != null)
                        {
                            <div class="alert alert-success">
                                <i class="bi bi-file-earmark-check me-2"></i>
                                –í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: <strong>@selectedFileName</strong>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
                            </div>
                        }

                        <div class="card bg-light mt-3">
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" @bind="hasHeaderRow" id="hasHeaderRow">
                                    <label class="form-check-label" for="hasHeaderRow">
                                        <strong>–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫</strong>
                                    </label>
                                </div>
                                <small class="text-muted d-block mb-3">
                                    –ï—Å–ª–∏ –æ—Ç–º–µ—á–µ–Ω–æ, –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫.
                                    –ï—Å–ª–∏ –Ω–µ –æ—Ç–º–µ—á–µ–Ω–æ, –∫–æ–ª–æ–Ω–∫–∏ –±—É–¥—É—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è "–ö–æ–ª–æ–Ω–∫–∞ 1", "–ö–æ–ª–æ–Ω–∫–∞ 2", –∏ —Ç.–¥.
                                </small>

                                <label for="encodingSelect" class="form-label"><strong>–ö–æ–¥–∏—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–∞:</strong></label>
                                <select class="form-select" @bind="selectedEncoding" id="encodingSelect">
                                    <option value="utf-8">UTF-8 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>
                                    <option value="utf-16">UTF-16 (Unicode)</option>
                                    <option value="windows-1252">Windows-1252 (ANSI)</option>
                                    <option value="iso-8859-1">ISO-8859-1 (Latin-1)</option>
                                </select>
                                <small class="text-muted">
                                    –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ _F_r_e_i_f_e_l_d_ - –≤—ã–±–µ—Ä–∏—Ç–µ UTF-16
                                </small>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-primary btn-lg" @onclick="AnalyzeFile"
                                disabled="@(selectedFile == null || isLoading)">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                else
                                {
                                    <i class="bi bi-search me-2"></i>
                                }
                                –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm bg-light">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-info-circle me-2"></i>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã</h5>
                        <ul class="small">
                            <li><strong>QIMy:</strong> –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç QIMy</li>
                            <li><strong>BMD NTCS:</strong> –≠–∫—Å–ø–æ—Ä—Ç –∏–∑ BMD</li>
                            <li><strong>Excel CSV:</strong> –õ—é–±–æ–π CSV –∏–∑ Excel</li>
                            <li><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π:</strong> –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å —Ä—É—á–Ω—ã–º mapping</li>
                        </ul>
                        <hr />
                        <p class="small text-muted mb-0">
                            <i class="bi bi-shield-check me-1"></i>
                            –ö–æ–¥–∏—Ä–æ–≤–∫–∞: Windows-1252 (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ–º–µ—Ü–∫–∏—Ö –∏ —Ä—É—Å—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤)
                        </p>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Step 2: Column Mapping -->
    @if (currentStep == ImportStep.ColumnMapping)
    {
        <div class="row">
            <div class="col-12">
                @if (csvHeaders.Any())
                {
                    <div class="alert alert-secondary mb-3">
                        <strong>üìä –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞:</strong>
                        <ul class="mb-0 mt-2">
                            <li><strong>–§–∞–π–ª:</strong> @selectedFileName</li>
                            <li><strong>–ö–æ–ª–æ–Ω–æ–∫ –Ω–∞–π–¥–µ–Ω–æ:</strong> @csvHeaders.Count</li>
                            <li><strong>–ü—Ä–∏–º–µ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö:</strong> @sampleData.Count</li>
                            <li><strong>–ö–æ–¥–∏—Ä–æ–≤–∫–∞:</strong> Windows-1252 —Å –∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º UTF-8</li>
                        </ul>
                        @if (csvHeaders.Count > 0)
                        {
                            <details class="mt-2">
                                <summary class="cursor-pointer"><small>üîç –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏ CSV</small></summary>
                                <div class="mt-2">
                                    <code style="white-space: pre-wrap; word-break: break-all;">
                                        @string.Join("; ", csvHeaders.Select((h, i) => $"[{i}] {h}"))
                                    </code>
                                </div>
                            </details>
                        }
                    </div>
                }

                <CsvColumnMapper 
                    CsvHeaders="@csvHeaders"
                    SampleData="@sampleData"
                    TargetFields="@targetFields"
                    RequiredFields="@requiredFields"
                    ColumnMapping="@columnMapping"
                    OnMappingChanged="OnMappingChanged" />
                
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary btn-lg" @onclick="PreviewWithMapping"
                                disabled="@(GetUnmappedRequiredCount() > 0 || isLoading)">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                else
                                {
                                    <i class="bi bi-eye me-2"></i>
                                }
                                –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å —ç—Ç–∏–º mapping
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="BackToFileSelection">
                                <i class="bi bi-arrow-left me-2"></i>–ù–∞–∑–∞–¥
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Step 3: Preview -->
    @if (currentStep == ImportStep.Preview && previewData != null)
    {
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">–®–∞–≥ 3: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–º–ø–æ—Ä—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫:</strong> @previewData.Count
                                </div>
                                <div class="col-md-3">
                                    <strong class="text-success">–í–∞–ª–∏–¥–Ω—ã—Ö:</strong> @previewData.Count(d => d.IsValid)
                                </div>
                                <div class="col-md-3">
                                    <strong class="text-danger">–° –æ—à–∏–±–∫–∞–º–∏:</strong> @previewData.Count(d => !d.IsValid)
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" @bind="skipErrors" id="skipErrors">
                                        <label class="form-check-label" for="skipErrors">
                                            –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ—à–∏–±–∫–∏
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>–°—Ç—Ä–æ–∫–∞</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞</th>
                                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                        <th>–°—Ç—Ä–∞–Ω–∞</th>
                                        <th>–ì–æ—Ä–æ–¥</th>
                                        <th>UID</th>
                                        <th>–û—à–∏–±–∫–∏</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in previewData.Take(100))
                                    {
                                        <tr class="@(item.IsValid ? "" : "table-danger")">
                                            <td>@item.RowNumber</td>
                                            <td>
                                                @if (item.IsValid)
                                                {
                                                    <i class="bi bi-check-circle text-success"></i>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-x-circle text-danger"></i>
                                                }
                                            </td>
                                            <td>@item.ClientCode</td>
                                            <td>@item.CompanyName</td>
                                            <td>@item.Country</td>
                                            <td>@item.City</td>
                                            <td>@item.VatNumber</td>
                                            <td>
                                                @if (!item.IsValid)
                                                {
                                                    <small class="text-danger">
                                                        @string.Join("; ", item.ValidationErrors)
                                                    </small>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        @if (previewData.Count > 100)
                        {
                            <div class="alert alert-warning mt-2">
                                –ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 100 —Å—Ç—Ä–æ–∫ –∏–∑ @previewData.Count.
                            </div>
                        }

                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-success btn-lg" @onclick="ExecuteImport"
                                disabled="@(previewData.All(d => !d.IsValid) || isLoading)">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                else
                                {
                                    <i class="bi bi-database-fill-add me-2"></i>
                                }
                                –í—ã–ø–æ–ª–Ω–∏—Ç—å –∏–º–ø–æ—Ä—Ç
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="BackToMapping">
                                <i class="bi bi-arrow-left me-2"></i>–ò–∑–º–µ–Ω–∏—Ç—å mapping
                            </button>
                            <button class="btn btn-outline-danger" @onclick="CancelImport">
                                <i class="bi bi-x-circle me-2"></i>–û—Ç–º–µ–Ω–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Step 4: Results -->
    @if (currentStep == ImportStep.Complete && importResult != null)
    {
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-check-circle me-2"></i>–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card text-center bg-success text-white">
                            <div class="card-body">
                                <h2>@importResult.SuccessCount</h2>
                                <p class="mb-0">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center bg-danger text-white">
                            <div class="card-body">
                                <h2>@importResult.ErrorCount</h2>
                                <p class="mb-0">–û—à–∏–±–æ–∫</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center bg-warning text-dark">
                            <div class="card-body">
                                <h2>@importResult.SkippedCount</h2>
                                <p class="mb-0">–ü—Ä–æ–ø—É—â–µ–Ω–æ</p>
                            </div>
                        </div>
                    </div>
                </div>

                @if (importResult.Errors.Any())
                {
                    <div class="mt-4">
                        <h6>–û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞:</h6>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>–°—Ç—Ä–æ–∫–∞</th>
                                        <th>–ö–æ–¥</th>
                                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                        <th>–û—à–∏–±–∫–∞</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var error in importResult.Errors)
                                    {
                                        <tr>
                                            <td>@error.RowNumber</td>
                                            <td>@error.ClientCode</td>
                                            <td>@error.CompanyName</td>
                                            <td>
                                                <small class="text-danger">
                                                    @error.ErrorMessage
                                                    @if (error.Details?.Any() == true)
                                                    {
                                                        <br />@string.Join(", ", error.Details)
                                                    }
                                                </small>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }

                <div class="mt-4 d-flex gap-2">
                    <a href="/AR/Clients" class="btn btn-success btn-lg">
                        <i class="bi bi-check-circle me-2"></i>–û—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
                    </a>
                    <button class="btn btn-outline-secondary" @onclick="ResetImport">
                        <i class="bi bi-arrow-repeat me-2"></i>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë
                    </button>
                </div>

                @if (importResult.SuccessCount > 0)
                {
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ @importResult.SuccessCount –∫–ª–∏–µ–Ω—Ç–æ–≤.</strong>
                        –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="/AR/Clients" class="alert-link">—Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤</a> —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
                    </div>
                }
            </div>
        </div>
    }

    @if (isLoading)
    {
        <div class="position-fixed top-50 start-50 translate-middle" style="z-index: 9999;">
            <div class="card shadow-lg">
                <div class="card-body text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <p class="mb-0">@loadingMessage</p>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private enum ImportStep
    {
        FileSelection,
        ColumnMapping,
        Preview,
        Complete
    }

    private ImportStep currentStep = ImportStep.FileSelection;
    private IBrowserFile? selectedFile;
    private string? selectedFileName;
    private byte[]? fileContent; // Cache file content in memory
    private string selectedEncoding = "utf-8"; // Encoding selector
    private bool isLoading = false;
    private string? errorMessage;
    private string loadingMessage = "–û–±—Ä–∞–±–æ—Ç–∫–∞...";

    // Column mapping data
    private List<string> csvHeaders = new();
    private Dictionary<string, string> sampleData = new();
    private Dictionary<string, string> columnMapping = new();
    private Dictionary<string, string> targetFields = new()
    {
        { "ClientCode", "–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞" },
        { "CompanyName", "–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏" },
        { "ExternalAccountNumber", "Externe KontoNr (–≤–Ω–µ—à–Ω–∏–π –Ω–æ–º–µ—Ä)" },
        { "Country", "–°—Ç—Ä–∞–Ω–∞" },
        { "CountryCode", "–ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã" },
        { "Address", "–ê–¥—Ä–µ—Å" },
        { "PostalCode", "–ò–Ω–¥–µ–∫—Å" },
        { "City", "–ì–æ—Ä–æ–¥" },
        { "VatNumber", "UID-–Ω–æ–º–µ—Ä" },
        { "Email", "Email" },
        { "Phone", "–¢–µ–ª–µ—Ñ–æ–Ω" },
        { "ContactPerson", "–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ" },
        { "AccountNumber", "–°—á–µ—Ç (Erl√∂skonto)" },
        { "PaymentTerms", "–£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã" },
        { "DiscountPercent", "–°–∫–∏–¥–∫–∞ %" },
        { "DiscountDays", "–î–Ω–∏ —Å–∫–∏–¥–∫–∏" },
        { "Currency", "–í–∞–ª—é—Ç–∞" },
        { "TaxNumber", "–ù–∞–ª–æ–≥–æ–≤—ã–π –Ω–æ–º–µ—Ä" },
        { "Branch", "–§–∏–ª–∏–∞–ª" },
        { "CountryNumber", "–ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω—ã (Land-Nr)" },
        { "Description", "–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥" },
        { "SupplierSuggestedAccount", "–°—á–µ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞" }
    };
    private List<string> requiredFields = new() { "ClientCode", "CompanyName" };

    // Preview data
    private List<ClientImportDto>? previewData;
    private bool skipErrors = true;
    private bool hasHeaderRow = true; // Default: first row is header

    // Import result
    private ImportResult? importResult;

    private const long MaxFileSize = 10 * 1024 * 1024; // 10MB

    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        selectedFileName = e.File.Name;
        errorMessage = null;
        
        // Read file into memory immediately to avoid Blazor file reference issues
        try
        {
            using var uploadStream = selectedFile.OpenReadStream(MaxFileSize);
            using var memoryStream = new MemoryStream();
            await uploadStream.CopyToAsync(memoryStream);
            fileContent = memoryStream.ToArray();
            
            Logger.LogInformation($"File loaded into memory: {selectedFileName}, {fileContent.Length} bytes");
        }
        catch (Exception ex)
        {
            errorMessage = $"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: {ex.Message}";
            Logger.LogError(ex, "Failed to load file into memory");
        }
    }

    private async Task AnalyzeFile()
    {
        if (fileContent == null) return;

        isLoading = true;
        loadingMessage = "–ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–∞...";
        errorMessage = null;

        try
        {
            // Analyze structure from cached file content
            using var analyzeStream = new MemoryStream(fileContent);
            var (headers, samples) = await ImportService.AnalyzeCsvStructureAsync(analyzeStream, hasHeaderRow, selectedEncoding);

            csvHeaders = headers;
            sampleData = samples;

            Logger.LogInformation($"Analyzed CSV: {csvHeaders.Count} columns, hasHeader: {hasHeaderRow}");

            currentStep = ImportStep.ColumnMapping;
        }
        catch (Exception ex)
        {
            errorMessage = $"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞: {ex.Message}";
            Logger.LogError(ex, "Failed to analyze CSV structure");
        }
        finally
        {
            isLoading = false;
        }
    }

    private Task OnMappingChanged(Dictionary<string, string> mapping)
    {
        columnMapping = mapping;
        Logger.LogInformation($"Column mapping updated: {mapping.Count} mappings");
        return Task.CompletedTask;
    }

    private async Task PreviewWithMapping()
    {
        if (fileContent == null || columnMapping.Count == 0) return;

        isLoading = true;
        loadingMessage = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å –≤–∞—à–∏–º mapping...";
        errorMessage = null;

        try
        {
            using var stream = new MemoryStream(fileContent);
            previewData = await ImportService.PreviewImportAsync(stream, columnMapping, selectedEncoding);

            Logger.LogInformation($"Preview loaded: {previewData.Count} rows, {previewData.Count(d => d.IsValid)} valid");

            currentStep = ImportStep.Preview;
        }
        catch (Exception ex)
        {
            errorMessage = $"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: {ex.Message}";
            Logger.LogError(ex, "Failed to load preview with mapping");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ExecuteImport()
    {
        if (fileContent == null || previewData == null) return;

        isLoading = true;
        loadingMessage = $"–ò–º–ø–æ—Ä—Ç {previewData.Count} –∑–∞–ø–∏—Å–µ–π...";
        errorMessage = null;

        try
        {
            using var stream = new MemoryStream(fileContent);
            importResult = await ImportService.ImportClientsAsync(stream, skipErrors, columnMapping, selectedEncoding);

            Logger.LogInformation($"Import completed: {importResult.SuccessCount} imported, {importResult.ErrorCount} errors");

            currentStep = ImportStep.Complete;
        }
        catch (Exception ex)
        {
            errorMessage = $"–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {ex.Message}";
            Logger.LogError(ex, "Import execution failed");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void BackToFileSelection()
    {
        currentStep = ImportStep.FileSelection;
        csvHeaders.Clear();
        sampleData.Clear();
        columnMapping.Clear();
        previewData = null;
    }

    private void BackToMapping()
    {
        currentStep = ImportStep.ColumnMapping;
        previewData = null;
    }

    private void CancelImport()
    {
        ResetImport();
    }

    private void ResetImport()
    {
        currentStep = ImportStep.FileSelection;
        selectedFile = null;
        selectedFileName = null;
        csvHeaders.Clear();
        sampleData.Clear();
        columnMapping.Clear();
        previewData = null;
        importResult = null;
        errorMessage = null;
    }

    private int GetUnmappedRequiredCount()
    {
        return requiredFields.Count(f => !columnMapping.ContainsKey(f));
    }
}
