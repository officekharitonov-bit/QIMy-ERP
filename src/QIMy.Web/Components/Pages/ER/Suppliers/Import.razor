@rendermode InteractiveServer
@page "/ER/Suppliers/Import"
@using QIMy.Application.Suppliers.Commands.ImportSuppliers
@using MediatR
@using Microsoft.AspNetCore.Components.Forms
@using QIMy.Web.Services
@inject IMediator Mediator
@inject NavigationManager NavigationManager
@inject ILogger<Import> Logger
@inject BusinessContext BusinessCtx

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-upload me-2"></i>Импорт поставщиков</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/ER/Suppliers">Suppliers</a></li>
                    <li class="breadcrumb-item active">Import</li>
                </ol>
            </nav>
        </div>
    </div>

    @if (currentStep == ImportStep.FileSelection)
    {
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Шаг 1: Выбор CSV файла</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-lightbulb me-2"></i>
                            <strong>Импорт поддерживает:</strong>
                            <ul class="mb-0">
                                <li>BMD Personenkonten (300000-399999 диапазон)</li>
                                <li>Стандартный CSV с разделителем ;</li>
                                <li>Автоматическое определение дубликатов</li>
                            </ul>
                        </div>

                        <InputFile OnChange="HandleFileSelection" class="form-control mb-3" accept=".csv" />

                        @if (selectedFileName != null)
                        {
                            <div class="alert alert-success">
                                <i class="bi bi-file-earmark-check me-2"></i>
                                Выбран файл: <strong>@selectedFileName</strong>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
                            </div>
                        }

                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-primary btn-lg" @onclick="ImportSuppliers"
                                disabled="@(selectedFile == null || isLoading)">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <text>Импортирую...</text>
                                }
                                else
                                {
                                    <i class="bi bi-upload me-2"></i>
                                    <text>Импортировать</text>
                                }
                            </button>
                            <a href="/ER/Suppliers" class="btn btn-secondary btn-lg">
                                <i class="bi bi-arrow-left me-2"></i>Назад
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Формат файла</h6>
                    </div>
                    <div class="card-body small">
                        <p><strong>BMD Format (Personenkonten):</strong></p>
                        <ul>
                            <li>Коды: 3xxxxx = Поставщики (300000-399999)</li>
                            <li>Delimiter: ; (точка с запятой)</li>
                            <li>Первая строка = метаданные (пропускается)</li>
                            <li>Вторая строка = заголовки</li>
                        </ul>
                        <p><strong>Стандартный CSV:</strong></p>
                        <pre
                            class="bg-light p-2 small">CompanyName;Email;Phone;Address;City;PostalCode;Country;VatNumber</pre>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (currentStep == ImportStep.Completed && importResult != null)
    {
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-check-circle me-2"></i>Импорт завершён</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 class="text-primary">@importResult.TotalRows</h3>
                                        <p class="mb-0">Всего строк</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3>@importResult.SuccessCount</h3>
                                        <p class="mb-0">✅ Успешно</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning">
                                    <div class="card-body text-center">
                                        <h3>@importResult.DuplicateCount</h3>
                                        <p class="mb-0">⏭️ Дубликатов</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h3>@importResult.FailureCount</h3>
                                        <p class="mb-0">❌ Ошибок</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (importResult.Errors.Any())
                        {
                            <div class="alert alert-warning">
                                <h6>Детали ошибок:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Строка</th>
                                                <th>Компания</th>
                                                <th>Ошибка</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var error in importResult.Errors.Take(20))
                                            {
                                                <tr>
                                                    <td>@error.RowNumber</td>
                                                    <td>@error.CompanyName</td>
                                                    <td>@error.ErrorMessage</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                @if (importResult.Errors.Count > 20)
                                {
                                    <small class="text-muted">... и ещё @(importResult.Errors.Count - 20) ошибок</small>
                                }
                            </div>
                        }

                        <div class="d-flex gap-2 mt-3">
                            <a href="/ER/Suppliers" class="btn btn-primary">
                                <i class="bi bi-list me-2"></i>Перейти к списку поставщиков
                            </a>
                            <button class="btn btn-secondary" @onclick="Reset">
                                <i class="bi bi-arrow-clockwise me-2"></i>Импортировать ещё
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private enum ImportStep
    {
        FileSelection,
        Completed
    }

    private ImportStep currentStep = ImportStep.FileSelection;
    private IBrowserFile? selectedFile;
    private string? selectedFileName;
    private string? errorMessage;
    private bool isLoading = false;

    private ImportSuppliersResult? importResult;

    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        selectedFileName = e.File.Name;
        errorMessage = null;
    }

    private async Task ImportSuppliers()
    {
        if (selectedFile == null || BusinessCtx.CurrentBusinessId == null) return;

        isLoading = true;
        errorMessage = null;

        try
        {
            Logger.LogInformation("Starting supplier import from {FileName}", selectedFileName);

            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);

            var command = new ImportSuppliersCommand
            {
                FileStream = stream,
                FileName = selectedFileName ?? "import.csv",
                BusinessId = BusinessCtx.CurrentBusinessId.Value
            };

            var result = await Mediator.Send(command);

            if (result.IsSuccess && result.Value != null)
            {
                importResult = result.Value;
                currentStep = ImportStep.Completed;
                Logger.LogInformation("Import completed: {Success} success, {Failed} failed, {Duplicates} duplicates",
                importResult.SuccessCount, importResult.FailureCount, importResult.DuplicateCount);
            }
            else
            {
                errorMessage = $"Ошибка импорта: {result.Error}";
                Logger.LogError("Import failed: {Error}", result.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during supplier import");
            errorMessage = $"Ошибка: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void Reset()
    {
        currentStep = ImportStep.FileSelection;
        selectedFile = null;
        selectedFileName = null;
        importResult = null;
        errorMessage = null;
    }
}
