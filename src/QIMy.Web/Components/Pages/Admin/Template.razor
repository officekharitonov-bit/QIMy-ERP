@page "/admin/template"
@using QIMy.Web.Services
@using QIMy.Core.Entities
@using QIMy.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@inject BusinessContext BusinessContext
@inject ApplicationDbContext Context
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Шаблон бизнеса</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h3><i class="bi bi-folder-symlink"></i> Шаблон бизнеса</h3>
            <p class="text-muted">Настройка базового шаблона для новых бизнесов. Данные из шаблона можно импортировать в
                любой бизнес.</p>
        </div>
    </div>

    @if (!isLoaded)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <!-- Client Areas -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Области клиентов</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light" title="Добавить"><i class="bi bi-plus-circle"></i></button>
                            <button class="btn btn-sm btn-light" title="Импорт CSV"><i class="bi bi-download"></i></button>
                            <button class="btn btn-sm btn-light" title="Экспорт CSV"><i class="bi bi-upload"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" placeholder="Поиск..."
                                @bind="searchClientAreas" @bind:event="oninput" />
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th style="width: 80px;">Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in GetFilteredClientAreas())
                                    {
                                        <tr>
                                            <td>@item.Code</td>
                                            <td>@item.Name</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary me-1" title="Редактировать"><i
                                                        class="bi bi-pencil"></i></button>
                                                <button class="btn btn-sm btn-danger" title="Удалить"><i
                                                        class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Types -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-people"></i> Типы клиентов</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light" title="Добавить"><i class="bi bi-plus-circle"></i></button>
                            <button class="btn btn-sm btn-light" title="Импорт CSV"><i class="bi bi-download"></i></button>
                            <button class="btn btn-sm btn-light" title="Экспорт CSV"><i class="bi bi-upload"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" placeholder="Поиск..."
                                @bind="searchClientTypes" @bind:event="oninput" />
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th style="width: 80px;">Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in GetFilteredClientTypes())
                                    {
                                        <tr>
                                            <td>@item.Code</td>
                                            <td>@item.Name</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary me-1" title="Редактировать"><i
                                                        class="bi bi-pencil"></i></button>
                                                <button class="btn btn-sm btn-danger" title="Удалить"><i
                                                        class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tax Rates -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-percent"></i> Налоговые ставки</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light" title="Добавить"><i class="bi bi-plus-circle"></i></button>
                            <button class="btn btn-sm btn-light" title="Импорт CSV"><i class="bi bi-download"></i></button>
                            <button class="btn btn-sm btn-light" title="Экспорт CSV"><i class="bi bi-upload"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" placeholder="Поиск..."
                                @bind="searchTaxRates" @bind:event="oninput" />
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th>Name</th>
                                        <th>Rate %</th>
                                        <th style="width: 80px;">Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in GetFilteredTaxRates())
                                    {
                                        <tr>
                                            <td>@item.Name</td>
                                            <td>@item.Rate.ToString("0.0")%</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary me-1" title="Редактировать"><i
                                                        class="bi bi-pencil"></i></button>
                                                <button class="btn btn-sm btn-danger" title="Удалить"><i
                                                        class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accounts -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-bank"></i> Счета</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light" title="Добавить"><i class="bi bi-plus-circle"></i></button>
                            <button class="btn btn-sm btn-light" title="Импорт CSV"><i class="bi bi-download"></i></button>
                            <button class="btn btn-sm btn-light" title="Экспорт CSV"><i class="bi bi-upload"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" placeholder="Поиск..."
                                @bind="searchAccounts" @bind:event="oninput" />
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th>Account #</th>
                                        <th>Name</th>
                                        <th style="width: 80px;">Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in GetFilteredAccounts())
                                    {
                                        <tr>
                                            <td>@item.AccountNumber</td>
                                            <td>@item.Name</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary me-1" title="Редактировать"><i
                                                        class="bi bi-pencil"></i></button>
                                                <button class="btn btn-sm btn-danger" title="Удалить"><i
                                                        class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Units -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-rulers"></i> Единицы измерения</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light" title="Добавить"><i class="bi bi-plus-circle"></i></button>
                            <button class="btn btn-sm btn-light" title="Импорт CSV"><i class="bi bi-download"></i></button>
                            <button class="btn btn-sm btn-light" title="Экспорт CSV"><i class="bi bi-upload"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" placeholder="Поиск..."
                                @bind="searchUnits" @bind:event="oninput" />
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th>Name</th>
                                        <th>Short</th>
                                        <th style="width: 80px;">Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in GetFilteredUnits())
                                    {
                                        <tr>
                                            <td>@item.Name</td>
                                            <td>@item.ShortName</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary me-1" title="Редактировать"><i
                                                        class="bi bi-pencil"></i></button>
                                                <button class="btn btn-sm btn-danger" title="Удалить"><i
                                                        class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Currencies -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-currency-exchange"></i> Валюты</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light" title="Добавить"><i class="bi bi-plus-circle"></i></button>
                            <button class="btn btn-sm btn-light" title="Импорт CSV"><i class="bi bi-download"></i></button>
                            <button class="btn btn-sm btn-light" title="Экспорт CSV"><i class="bi bi-upload"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" placeholder="Поиск..."
                                @bind="searchCurrencies" @bind:event="oninput" />
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th style="width: 80px;">Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in GetFilteredCurrencies())
                                    {
                                        <tr>
                                            <td>@item.Code</td>
                                            <td>@item.Name</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary me-1" title="Редактировать"><i
                                                        class="bi bi-pencil"></i></button>
                                                <button class="btn btn-sm btn-danger" title="Удалить"><i
                                                        class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-credit-card"></i> Способы оплаты</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light" title="Добавить"><i class="bi bi-plus-circle"></i></button>
                            <button class="btn btn-sm btn-light" title="Импорт CSV"><i class="bi bi-download"></i></button>
                            <button class="btn btn-sm btn-light" title="Экспорт CSV"><i class="bi bi-upload"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" placeholder="Поиск..."
                                @bind="searchPaymentMethods" @bind:event="oninput" />
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th>Name</th>
                                        <th>Default</th>
                                        <th style="width: 80px;">Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in GetFilteredPaymentMethods())
                                    {
                                        <tr>
                                            <td>@item.Name</td>
                                            <td>@(item.IsDefault ? "✓" : "")</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary me-1" title="Редактировать"><i
                                                        class="bi bi-pencil"></i></button>
                                                <button class="btn btn-sm btn-danger" title="Удалить"><i
                                                        class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private const int TEMPLATE_BUSINESS_ID = 1;
    private bool isLoaded = false;

    private List<ClientArea> clientAreas = new();
    private List<ClientType> clientTypes = new();
    private List<TaxRate> taxRates = new();
    private List<Account> accounts = new();
    private List<Unit> units = new();
    private List<Currency> currencies = new();
    private List<PaymentMethod> paymentMethods = new();

    // Search filters
    private string searchClientAreas = "";
    private string searchClientTypes = "";
    private string searchTaxRates = "";
    private string searchAccounts = "";
    private string searchUnits = "";
    private string searchCurrencies = "";
    private string searchPaymentMethods = "";

    protected override async Task OnInitializedAsync()
    {
        await BusinessContext.SetBusinessAsync(TEMPLATE_BUSINESS_ID, saveDefault: false);
        await LoadTemplateData();
    }

    private async Task LoadTemplateData()
    {
        try
        {
            clientAreas = await Context.ClientAreas.Where(x => x.BusinessId == TEMPLATE_BUSINESS_ID).ToListAsync();
            clientTypes = await Context.ClientTypes.Where(x => x.BusinessId == TEMPLATE_BUSINESS_ID).ToListAsync();
            taxRates = await Context.TaxRates.Where(x => x.BusinessId == TEMPLATE_BUSINESS_ID).ToListAsync();
            accounts = await Context.Accounts.Where(x => x.BusinessId == TEMPLATE_BUSINESS_ID).ToListAsync();
            units = await Context.Units.Where(x => x.BusinessId == TEMPLATE_BUSINESS_ID).ToListAsync();
            currencies = await Context.Currencies.Where(x => x.BusinessId == TEMPLATE_BUSINESS_ID).ToListAsync();
            paymentMethods = await Context.PaymentMethods.Where(x => x.BusinessId == TEMPLATE_BUSINESS_ID).ToListAsync();

            isLoaded = true;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Ошибка загрузки данных шаблона: {ex.Message}");
        }
    }

    // Filter methods
    private IEnumerable<ClientArea> GetFilteredClientAreas() =>
    string.IsNullOrWhiteSpace(searchClientAreas)
    ? clientAreas
    : clientAreas.Where(x =>
    (x.Code?.Contains(searchClientAreas, StringComparison.OrdinalIgnoreCase) ?? false) ||
    (x.Name?.Contains(searchClientAreas, StringComparison.OrdinalIgnoreCase) ?? false));

    private IEnumerable<ClientType> GetFilteredClientTypes() =>
    string.IsNullOrWhiteSpace(searchClientTypes)
    ? clientTypes
    : clientTypes.Where(x =>
    (x.Code?.Contains(searchClientTypes, StringComparison.OrdinalIgnoreCase) ?? false) ||
    (x.Name?.Contains(searchClientTypes, StringComparison.OrdinalIgnoreCase) ?? false));

    private IEnumerable<TaxRate> GetFilteredTaxRates() =>
    string.IsNullOrWhiteSpace(searchTaxRates)
    ? taxRates
    : taxRates.Where(x =>
    (x.Name?.Contains(searchTaxRates, StringComparison.OrdinalIgnoreCase) ?? false) ||
    x.Rate.ToString().Contains(searchTaxRates));

    private IEnumerable<Account> GetFilteredAccounts() =>
    string.IsNullOrWhiteSpace(searchAccounts)
    ? accounts
    : accounts.Where(x =>
    (x.AccountNumber?.Contains(searchAccounts, StringComparison.OrdinalIgnoreCase) ?? false) ||
    (x.Name?.Contains(searchAccounts, StringComparison.OrdinalIgnoreCase) ?? false));

    private IEnumerable<Unit> GetFilteredUnits() =>
    string.IsNullOrWhiteSpace(searchUnits)
    ? units
    : units.Where(x =>
    (x.Name?.Contains(searchUnits, StringComparison.OrdinalIgnoreCase) ?? false) ||
    (x.ShortName?.Contains(searchUnits, StringComparison.OrdinalIgnoreCase) ?? false));

    private IEnumerable<Currency> GetFilteredCurrencies() =>
    string.IsNullOrWhiteSpace(searchCurrencies)
    ? currencies
    : currencies.Where(x =>
    (x.Code?.Contains(searchCurrencies, StringComparison.OrdinalIgnoreCase) ?? false) ||
    (x.Name?.Contains(searchCurrencies, StringComparison.OrdinalIgnoreCase) ?? false));

    private IEnumerable<PaymentMethod> GetFilteredPaymentMethods() =>
    string.IsNullOrWhiteSpace(searchPaymentMethods)
    ? paymentMethods
    : paymentMethods.Where(x =>
    (x.Name?.Contains(searchPaymentMethods, StringComparison.OrdinalIgnoreCase) ?? false));
}
