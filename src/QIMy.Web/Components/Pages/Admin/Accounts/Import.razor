@rendermode InteractiveServer
@page "/Admin/Accounts/Import"
@using MediatR
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using QIMy.Web.Services
@using QIMy.Core.Entities
@using QIMy.Infrastructure.Data
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject ILogger<Import> Logger
@inject BusinessContext BusinessCtx

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-upload me-2"></i>Импорт Sachkonten (План счетов)</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/Admin/Accounts">Accounts</a></li>
                    <li class="breadcrumb-item active">Import</li>
                </ol>
            </nav>
        </div>
    </div>

    @if (currentStep == ImportStep.FileSelection)
    {
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Шаг 1: Выбор CSV файла</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-lightbulb me-2"></i>
                            <strong>Импорт BMD Sachkonten:</strong>
                            <ul class="mb-0">
                                <li>Полный план счетов (Erlöskonten, Aufwandskonten, и т.д.)</li>
                                <li>Delimiter: ; (точка с запятой)</li>
                                <li>Автоматическое определение типа счета</li>
                                <li>Пропуск существующих счетов</li>
                            </ul>
                        </div>

                        <InputFile OnChange="HandleFileSelection" class="form-control mb-3" accept=".csv" />

                        @if (selectedFileName != null)
                        {
                            <div class="alert alert-success">
                                <i class="bi bi-file-earmark-check me-2"></i>
                                Выбран файл: <strong>@selectedFileName</strong>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
                            </div>
                        }

                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-primary btn-lg" @onclick="ImportAccounts"
                                disabled="@(selectedFile == null || isLoading)">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <text>Импортирую...</text>
                                }
                                else
                                {
                                    <i class="bi bi-upload me-2"></i>
                                    <text>Импортировать</text>
                                }
                            </button>
                            <a href="/Admin/Accounts" class="btn btn-secondary btn-lg">
                                <i class="bi bi-arrow-left me-2"></i>Назад
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Формат BMD Sachkonten</h6>
                    </div>
                    <div class="card-body small">
                        <p><strong>Структура файла:</strong></p>
                        <ul>
                            <li>Строка 1: Метаданные (пропускается)</li>
                            <li>Строка 2: Заголовки</li>
                            <li>Строка 3+: Данные счетов</li>
                        </ul>
                        <p><strong>Колонки:</strong></p>
                        <ol class="small">
                            <li>Externe KontoNr</li>
                            <li>Kto-Nr (номер счета)</li>
                            <li>Bezeichnung (название)</li>
                            <li>Ust-Code</li>
                            <li>Vorschlagskonto (код)</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (currentStep == ImportStep.Completed)
    {
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-check-circle me-2"></i>Импорт завершён</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 class="text-primary">@totalRows</h3>
                                        <p class="mb-0">Всего строк</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3>@successCount</h3>
                                        <p class="mb-0">✅ Импортировано</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning">
                                    <div class="card-body text-center">
                                        <h3>@skippedCount</h3>
                                        <p class="mb-0">⏭️ Пропущено</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h3>@errorCount</h3>
                                        <p class="mb-0">❌ Ошибок</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (errors.Any())
                        {
                            <div class="alert alert-warning">
                                <h6>Детали ошибок:</h6>
                                <ul>
                                    @foreach (var error in errors.Take(20))
                                    {
                                        <li>@error</li>
                                    }
                                </ul>
                                @if (errors.Count > 20)
                                {
                                    <small class="text-muted">... и ещё @(errors.Count - 20) ошибок</small>
                                }
                            </div>
                        }

                        <div class="d-flex gap-2 mt-3">
                            <a href="/Admin/Accounts" class="btn btn-primary">
                                <i class="bi bi-list me-2"></i>Перейти к списку счетов
                            </a>
                            <button class="btn btn-secondary" @onclick="Reset">
                                <i class="bi bi-arrow-clockwise me-2"></i>Импортировать ещё
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private enum ImportStep
    {
        FileSelection,
        Completed
    }

    private ImportStep currentStep = ImportStep.FileSelection;
    private IBrowserFile? selectedFile;
    private string? selectedFileName;
    private string? errorMessage;
    private bool isLoading = false;

    private int totalRows = 0;
    private int successCount = 0;
    private int skippedCount = 0;
    private int errorCount = 0;
    private List<string> errors = new();

    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        selectedFileName = e.File.Name;
        errorMessage = null;
    }

    private async Task ImportAccounts()
    {
        if (selectedFile == null || BusinessCtx.CurrentBusinessId == null) return;

        isLoading = true;
        errorMessage = null;
        totalRows = 0;
        successCount = 0;
        skippedCount = 0;
        errorCount = 0;
        errors.Clear();

        try
        {
            Logger.LogInformation("Starting Sachkonten import from {FileName}", selectedFileName);

            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            
            // Auto-detect encoding
            var encoding = DetectEncoding(stream);
            stream.Position = 0;
            Logger.LogInformation("Detected encoding: {EncodingName}", encoding.EncodingName);
            
            using var reader = new StreamReader(stream, encoding);

            var allLines = new List<string>();
            string? line;
            while ((line = await reader.ReadLineAsync()) != null)
            {
                allLines.Add(line);
            }

            Logger.LogInformation("Read {Count} lines from file", allLines.Count);

            if (allLines.Count < 3)
            {
                errorMessage = "Файл пустой или содержит недостаточно данных";
                return;
            }

            // Get default tax rate
            var defaultTaxRate = await DbContext.TaxRates.FirstOrDefaultAsync();

            // Skip metadata (line 0) and header (line 1), start from line 2
            for (int i = 2; i < allLines.Count; i++)
            {
                totalRows++;
                var dataLine = allLines[i];

                if (string.IsNullOrWhiteSpace(dataLine))
                {
                    skippedCount++;
                    continue;
                }

                var parts = dataLine.Split(';');

                if (parts.Length < 5)
                {
                    errorCount++;
                    errors.Add($"Строка {i + 1}: недостаточно колонок ({parts.Length})");
                    continue;
                }

                string GetPart(int idx) => idx < parts.Length ? parts[idx].Trim() : string.Empty;

                var accountNumberStr = GetPart(1); // Kto-Nr
                var accountName = GetPart(2);      // Bezeichnung
                var taxCode = GetPart(3);          // Ust-Code
                var code = GetPart(4);             // Vorschlagskonto (Code)

                if (string.IsNullOrWhiteSpace(accountNumberStr) || string.IsNullOrWhiteSpace(accountName))
                {
                    errorCount++;
                    errors.Add($"Строка {i + 1}: отсутствует номер счета или название");
                    continue;
                }

                if (!int.TryParse(accountNumberStr, out var accountNumber))
                {
                    errorCount++;
                    errors.Add($"Строка {i + 1}: неверный формат номера счета '{accountNumberStr}'");
                    continue;
                }

                // Check if account exists
                var exists = await DbContext.Accounts.AnyAsync(a => a.AccountNumber == accountNumberStr && !a.IsDeleted);
                if (exists)
                {
                    skippedCount++;
                    Logger.LogDebug("Account {AccountNumber} already exists, skipping", accountNumber);
                    continue;
                }

                try
                {
                    var account = new Account
                    {
                        AccountNumber = accountNumberStr,
                        Name = accountName,
                        AccountCode = code,
                        DefaultTaxRateId = defaultTaxRate?.Id,
                        BusinessId = BusinessCtx.CurrentBusinessId.Value,
                        CreatedAt = DateTime.UtcNow,
                        IsDeleted = false
                    };

                    DbContext.Accounts.Add(account);
                    successCount++;
                    Logger.LogInformation("✅ Imported account: {AccountNumber} - {Name}", accountNumber, accountName);
                }
                catch (Exception ex)
                {
                    errorCount++;
                    errors.Add($"Строка {i + 1}: {ex.Message}");
                    Logger.LogError(ex, "Error importing account {AccountNumber}", accountNumber);
                }
            }

            await DbContext.SaveChangesAsync();
            currentStep = ImportStep.Completed;

            Logger.LogInformation("Sachkonten import completed: {Success} success, {Skipped} skipped, {Errors} errors",
                successCount, skippedCount, errorCount);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Critical error during Sachkonten import");
            errorMessage = $"Критическая ошибка: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void Reset()
    {
        currentStep = ImportStep.FileSelection;
        selectedFile = null;
        selectedFileName = null;
        errorMessage = null;
        totalRows = 0;
        successCount = 0;
        skippedCount = 0;
        errorCount = 0;
        errors.Clear();
    }

    private System.Text.Encoding DetectEncoding(Stream stream)
    {
        // Read first 4 bytes to check for BOM
        var bom = new byte[4];
        var bytesRead = stream.Read(bom, 0, 4);
        stream.Position = 0;

        // Check for UTF-8 BOM (EF BB BF)
        if (bytesRead >= 3 && bom[0] == 0xEF && bom[1] == 0xBB && bom[2] == 0xBF)
        {
            return System.Text.Encoding.UTF8;
        }

        // Check for UTF-16 LE BOM (FF FE)
        if (bytesRead >= 2 && bom[0] == 0xFF && bom[1] == 0xFE)
        {
            return System.Text.Encoding.Unicode;
        }

        // Check for UTF-16 BE BOM (FE FF)
        if (bytesRead >= 2 && bom[0] == 0xFE && bom[1] == 0xFF)
        {
            return System.Text.Encoding.BigEndianUnicode;
        }

        // Default to Windows-1252 (common for BMD/Austrian accounting software)
        return System.Text.Encoding.GetEncoding("windows-1252");
    }
}
