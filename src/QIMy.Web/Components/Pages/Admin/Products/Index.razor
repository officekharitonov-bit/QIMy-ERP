@page "/admin/products"
@using QIMy.Application.Products.DTOs
@using QIMy.Application.Products.Commands.DeleteProduct
@using QIMy.Application.Products.Commands.CreateProduct
@using QIMy.Application.Products.Commands.UpdateProduct
@using QIMy.Application.Products.Queries.GetAllProducts
@using QIMy.AI.Services
@using MediatR
@using QIMy.Web.Services
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject BusinessContext BusinessCtx
@inject IAiEncodingDetectionService AiEncoding
@inject ILogger<Index> Logger
@rendermode InteractiveServer

<PageTitle>Products</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>üì¶ Products & Services (–¢–æ–≤–∞—Ä—ã –∏ —É—Å–ª—É–≥–∏)</h3>
    <a href="/admin/products/create" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å Product
    </a>
</div>

<div class="card mb-3">
    <div class="card-body d-flex flex-wrap gap-2 align-items-center">
        <button class="btn btn-outline-secondary" @onclick="ExportCsv">
            <i class="bi bi-download me-1"></i> Download list (CSV)
        </button>
        <InputFile OnChange="ImportCsv" accept=".csv,text/csv" class="form-control" />
        <div class="form-check ms-2">
            <input class="form-check-input" type="checkbox" id="updateExisting" @bind="updateExisting" />
            <label class="form-check-label" for="updateExisting">
                Update existing (match by SKU)
            </label>
        </div>
        @if (selectedProducts.Any())
        {
            <button class="btn btn-danger ms-auto" @onclick="DeleteSelected">
                <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (@selectedProducts.Count)
            </button>
        }
    </div>
    <div class="px-3 pb-2 text-muted">
        –§–æ—Ä–º–∞—Ç CSV: <code>SKU;Name;Description;Price;UnitId;TaxRateId;IsService;StockQuantity</code>
    </div>
</div>

@if (products == null)
{
    <p><em>–ó–∞–≥—Ä—É–∑–∫–∞...</em></p>
}
else if (!products.Any())
{
    <div class="alert alert-info">
        –¢–æ–≤–∞—Ä—ã –∏ —É—Å–ª—É–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä!
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" class="form-check-input" @onchange="ToggleSelectAll"
                            checked="@(products.Any() && selectedProducts.Count == products.Count)" />
                    </th>
                    <th>SKU</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Price (‚Ç¨)</th>
                    <th>Unit</th>
                    <th>Tax Rate</th>
                    <th>Type</th>
                    <th>Stock</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in products)
                {
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input" checked="@selectedProducts.Contains(product.Id)"
                                @onchange="() => ToggleSelect(product.Id)" />
                        </td>
                        <td><strong>@product.SKU</strong></td>
                        <td>@product.Name</td>
                        <td>@product.Description</td>
                        <td>@product.Price.ToString("F2")</td>
                        <td>@(product.UnitName ?? "-")</td>
                        <td>@(product.TaxRateName ?? "-")</td>
                        <td>
                            @if (product.IsService)
                            {
                                <span class="badge bg-info">üîß Service</span>
                            }
                            else
                            {
                                <span class="badge bg-primary">üì¶ Product</span>
                            }
                        </td>
                        <td>@(product.IsService ? "-" : product.StockQuantity.ToString())</td>
                        <td>
                            <a href="/admin/products/edit/@product.Id" class="btn btn-sm btn-warning">
                                <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteProduct(product.Id)">
                                <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<ProductDto>? products;
    private bool updateExisting = true;
    private HashSet<int> selectedProducts = new();

    protected override async Task OnInitializedAsync()
    {
        await BusinessCtx.InitializeAsync();
        BusinessCtx.Changed += async () =>
        {
            await LoadData();
            StateHasChanged();
        };
        await LoadData();
    }

    private async Task LoadData()
    {
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ Query (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
        var query = new GetAllProductsQuery
        {
            BusinessId = BusinessCtx.CurrentBusinessId
        };
        var result = await Mediator.Send(query);
        products = result.OrderBy(x => x.Name).ToList();
    }

    private void ToggleSelect(int id)
    {
        if (selectedProducts.Contains(id))
            selectedProducts.Remove(id);
        else
            selectedProducts.Add(id);
    }

    private void ToggleSelectAll(ChangeEventArgs e)
    {
        if ((bool?)e.Value == true)
            selectedProducts = products!.Select(p => p.Id).ToHashSet();
        else
            selectedProducts.Clear();
    }

    private async Task DeleteSelected()
    {
        if (!selectedProducts.Any()) return;

        if (await JS.InvokeAsync<bool>("confirm", $"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å {selectedProducts.Count} —Ç–æ–≤–∞—Ä(–æ–≤)?"))
        {
            var errors = new List<string>();
            foreach (var id in selectedProducts.ToList())
            {
                var command = new DeleteProductCommand(id);
                var result = await Mediator.Send(command);
                if (!result.IsSuccess)
                    errors.Add($"ID {id}: {result.Error}");
            }

            selectedProducts.Clear();
            await LoadData();

            if (errors.Any())
                await JS.InvokeVoidAsync("alert", $"–£–¥–∞–ª–µ–Ω–æ —Å –æ—à–∏–±–∫–∞–º–∏:\n{string.Join("\n", errors)}");
        }
    }

    private async Task DeleteProduct(int id)
    {
        if (await JS.InvokeAsync<bool>("confirm", "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?"))
        {
            var command = new DeleteProductCommand(id);
            var result = await Mediator.Send(command);

            if (result.IsSuccess)
            {
                await LoadData();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", $"–û—à–∏–±–∫–∞: {result.Error}");
            }
        }
    }

    private async Task ExportCsv()
    {
        if (products == null || !products.Any())
        {
            await JS.InvokeVoidAsync("alert", "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.");
            return;
        }

        var sb = new System.Text.StringBuilder();
        sb.AppendLine("SKU;Name;Description;Price;UnitId;TaxRateId;IsService;StockQuantity");
        foreach (var p in products)
        {
            var sku = (p.SKU ?? string.Empty).Replace(";", ",");
            var name = (p.Name ?? string.Empty).Replace(";", ",");
            var desc = (p.Description ?? string.Empty).Replace(";", ",");
            var price = p.Price.ToString(System.Globalization.CultureInfo.InvariantCulture);
            var unitId = p.UnitId?.ToString() ?? string.Empty;
            var taxId = p.TaxRateId?.ToString() ?? string.Empty;
            var isService = p.IsService ? "1" : "0";
            var stock = p.StockQuantity.ToString();
            sb.AppendLine($"{sku};{name};{desc};{price};{unitId};{taxId};{isService};{stock}");
        }

        // Add UTF-8 BOM for proper encoding detection
        var utf8WithBom = new System.Text.UTF8Encoding(true);
        var bytes = utf8WithBom.GetBytes(sb.ToString());
        var base64 = Convert.ToBase64String(bytes);
        var fileName = $"products-{DateTime.UtcNow:yyyyMMddHHmmss}.csv";
        await JS.InvokeVoidAsync("downloadFile", fileName, "text/csv", base64);
    }

    private async Task ImportCsv(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file == null) return;

            // BrowserFileStream doesn't support Position, so copy to MemoryStream first
            using var browserStream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
            using var memoryStream = new MemoryStream();
            await browserStream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;

            // ü§ñ AI-enhanced encoding detection
            var encoding = await DetectEncodingAsync(memoryStream);
            memoryStream.Position = 0; // Reset after detection
            Logger.LogInformation("‚úÖ –ö–æ–¥–∏—Ä–æ–≤–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞: {EncodingName}", encoding.EncodingName);

            using var reader = new StreamReader(memoryStream, encoding);
            var content = await reader.ReadToEndAsync();
            if (string.IsNullOrWhiteSpace(content)) return;

            var lines = content.Replace("\r", string.Empty).Split('\n');
            int processed = 0, created = 0, updated = 0;

            foreach (var raw in lines)
            {
                var line = raw.Trim();
                if (string.IsNullOrWhiteSpace(line)) continue;
                if (line.StartsWith("SKU", StringComparison.OrdinalIgnoreCase)) continue; // header

                string[] parts = line.Contains(';') ? line.Split(';') : line.Split(',');
                if (parts.Length < 4) continue; // require at least SKU;Name;Description;Price

                var sku = parts[0].Trim();
                var name = parts[1].Trim();
                var desc = parts[2].Trim();
                var priceStr = parts[3].Trim();

                // optional
                int? unitId = null; if (parts.Length > 4 && int.TryParse(parts[4].Trim(), out var u)) unitId = u;
                int? taxRateId = null; if (parts.Length > 5 && int.TryParse(parts[5].Trim(), out var t)) taxRateId = t;
                bool isService = false; if (parts.Length > 6) isService = parts[6].Trim() == "1" || parts[6].Trim().Equals("true",
                StringComparison.OrdinalIgnoreCase);
                int stock = 0; if (parts.Length > 7 && int.TryParse(parts[7].Trim(), out var s)) stock = s;

                if (!decimal.TryParse(priceStr, System.Globalization.NumberStyles.Float,
                System.Globalization.CultureInfo.InvariantCulture, out var price))
                {
                    // try RU/DE cultures
                    if (!decimal.TryParse(priceStr, System.Globalization.NumberStyles.Float, new System.Globalization.CultureInfo("ru-RU"),
                    out price))
                        decimal.TryParse(priceStr, System.Globalization.NumberStyles.Float, new System.Globalization.CultureInfo("de-DE"), out
                        price);
                }

                if (updateExisting)
                {
                    // Try find existing by SKU in loaded list first
                    var existing = products?.FirstOrDefault(p => string.Equals(p.SKU ?? string.Empty, sku,
                    StringComparison.OrdinalIgnoreCase));
                    if (existing != null)
                    {
                        var cmd = new UpdateProductCommand
                        {
                            Id = existing.Id,
                            Name = name,
                            Description = desc,
                            SKU = sku,
                            Price = price,
                            UnitId = unitId,
                            TaxRateId = taxRateId,
                            IsService = isService,
                            StockQuantity = stock
                        };
                        var res = await Mediator.Send(cmd);
                        if (res.IsSuccess)
                        {
                            updated++;
                            processed++;
                        }
                        else
                        {
                            await JS.InvokeVoidAsync("console.warn", $"Update failed: {res.Error}");
                        }
                        continue;
                    }
                }

                var create = new CreateProductCommand
                {
                    BusinessId = BusinessCtx.CurrentBusinessId,
                    Name = name,
                    Description = desc,
                    SKU = sku,
                    Price = price,
                    UnitId = unitId,
                    TaxRateId = taxRateId,
                    IsService = isService,
                    StockQuantity = stock
                };
                var createdRes = await Mediator.Send(create);
                if (createdRes.IsSuccess)
                {
                    created++;
                    processed++;
                }
                else
                {
                    await JS.InvokeVoidAsync("console.warn", $"Create failed: {createdRes.Error}");
                }
            }

            await LoadData();
            await JS.InvokeVoidAsync("alert", $"–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {processed}, —Å–æ–∑–¥–∞–Ω–æ: {created}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: {updated}.");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {ex.Message}");
        }
    }

    private async Task<System.Text.Encoding> DetectEncodingAsync(Stream stream)
    {
        Logger.LogInformation("ü§ñ AI Encoding Detection –Ω–∞—á–∞—Ç...");

        try
        {
            var detectionResult = await AiEncoding.DetectEncodingAsync(stream);

            Logger.LogInformation(
            "ü§ñ AI –æ–ø—Ä–µ–¥–µ–ª–∏–ª –∫–æ–¥–∏—Ä–æ–≤–∫—É: {Encoding} (Confidence: {Confidence:P}, Method: {Method})",
            detectionResult.Encoding.EncodingName,
            detectionResult.Confidence,
            detectionResult.DetectionMethod);

            if (detectionResult.Alternatives.Any())
            {
                Logger.LogDebug("–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: {Alternatives}",
                string.Join(", ", detectionResult.Alternatives
                .Select(a => $"{a.Encoding.EncodingName} ({a.Confidence:P})")));
            }

            // Log warning if confidence is low
            if (detectionResult.Confidence < 0.7m)
            {
                Logger.LogWarning(
                "‚ö†Ô∏è –ù–∏–∑–∫–∏–π confidence score ({Confidence:P}). –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.",
                detectionResult.Confidence);
            }

            return detectionResult.Encoding;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "–û—à–∏–±–∫–∞ AI encoding detection, –∏—Å–ø–æ–ª—å–∑—É—é fallback");

            // Fallback to old method
            return await DetectEncodingFallbackAsync(stream);
        }
    }

    private async Task<System.Text.Encoding> DetectEncodingFallbackAsync(Stream stream)
    {
        // For BrowserFileStream, copy to memory first since Position is not supported
        using var memoryStream = new MemoryStream();
        await stream.CopyToAsync(memoryStream);
        memoryStream.Position = 0;

        // Read first 256 bytes for analysis
        var buffer = new byte[256];
        var bytesRead = await memoryStream.ReadAsync(buffer, 0, buffer.Length);
        memoryStream.Position = 0;

        if (bytesRead < 4) return System.Text.Encoding.UTF8;

        // Check for UTF-8 BOM (EF BB BF)
        if (bytesRead >= 3 && buffer[0] == 0xEF && buffer[1] == 0xBB && buffer[2] == 0xBF)
        {
            return System.Text.Encoding.UTF8;
        }

        // Check for UTF-16 LE BOM (FF FE)
        if (bytesRead >= 2 && buffer[0] == 0xFF && buffer[1] == 0xFE)
        {
            return System.Text.Encoding.Unicode;
        }

        // Check for UTF-16 BE BOM (FE FF)
        if (bytesRead >= 2 && buffer[0] == 0xFE && buffer[1] == 0xFF)
        {
            return System.Text.Encoding.BigEndianUnicode;
        }

        // Heuristic: Check for UTF-16 LE without BOM
        // In UTF-16 LE, ASCII characters have pattern: [char] [00]
        // Check if every second byte is 0x00 for first ~100 chars
        int nullCount = 0;
        int evenPositions = 0;
        for (int i = 1; i < Math.Min(bytesRead, 200); i += 2)
        {
            evenPositions++;
            if (buffer[i] == 0x00) nullCount++;
        }
        // If >80% of even positions are null bytes, it's likely UTF-16 LE
        if (evenPositions > 0 && (double)nullCount / evenPositions > 0.8)
        {
            Logger.LogInformation("üîç Detected UTF-16 LE without BOM (heuristic: {Ratio:P0})", (double)nullCount / evenPositions);
            return System.Text.Encoding.Unicode;
        }

        // Heuristic: Check for UTF-16 BE without BOM
        // In UTF-16 BE, ASCII characters have pattern: [00] [char]
        nullCount = 0;
        int oddPositions = 0;
        for (int i = 0; i < Math.Min(bytesRead, 200); i += 2)
        {
            oddPositions++;
            if (buffer[i] == 0x00) nullCount++;
        }
        // If >80% of odd positions are null bytes, it's likely UTF-16 BE
        if (oddPositions > 0 && (double)nullCount / oddPositions > 0.8)
        {
            Logger.LogInformation("üîç Detected UTF-16 BE without BOM (heuristic: {Ratio:P0})", (double)nullCount / oddPositions);
            return System.Text.Encoding.BigEndianUnicode;
        }

        // Default to Windows-1252 (common for BMD/Austrian accounting software)
        return System.Text.Encoding.GetEncoding("windows-1252");
    }
}
