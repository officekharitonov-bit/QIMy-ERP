@page "/admin/products"
@using QIMy.Application.Products.DTOs
@using QIMy.Application.Products.Commands.DeleteProduct
@using QIMy.Application.Products.Commands.CreateProduct
@using QIMy.Application.Products.Commands.UpdateProduct
@using QIMy.Application.Products.Queries.GetAllProducts
@using MediatR
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Products</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>üì¶ Products & Services (–¢–æ–≤–∞—Ä—ã –∏ —É—Å–ª—É–≥–∏)</h3>
    <a href="/admin/products/create" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å Product
    </a>
</div>

<div class="card mb-3">
    <div class="card-body d-flex flex-wrap gap-2 align-items-center">
        <button class="btn btn-outline-secondary" @onclick="ExportCsv">
            <i class="bi bi-download me-1"></i> Download list (CSV)
        </button>
        <InputFile OnChange="ImportCsv" accept=".csv,text/csv" class="form-control" />
        <div class="form-check ms-2">
            <input class="form-check-input" type="checkbox" id="updateExisting" @bind="updateExisting" />
            <label class="form-check-label" for="updateExisting">
                Update existing (match by SKU)
            </label>
        </div>
    </div>
    <div class="px-3 pb-2 text-muted">
        –§–æ—Ä–º–∞—Ç CSV: <code>SKU;Name;Description;Price;UnitId;TaxRateId;IsService;StockQuantity</code>
    </div>
</div>

@if (products == null)
{
    <p><em>–ó–∞–≥—Ä—É–∑–∫–∞...</em></p>
}
else if (!products.Any())
{
    <div class="alert alert-info">
        –¢–æ–≤–∞—Ä—ã –∏ —É—Å–ª—É–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä!
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>SKU</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Price (‚Ç¨)</th>
                    <th>Unit</th>
                    <th>Tax Rate</th>
                    <th>Type</th>
                    <th>Stock</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in products)
                {
                    <tr>
                        <td><strong>@product.SKU</strong></td>
                        <td>@product.Name</td>
                        <td>@product.Description</td>
                        <td>@product.Price.ToString("F2")</td>
                        <td>@(product.UnitName ?? "-")</td>
                        <td>@(product.TaxRateName ?? "-")</td>
                        <td>
                            @if (product.IsService)
                            {
                                <span class="badge bg-info">üîß Service</span>
                            }
                            else
                            {
                                <span class="badge bg-primary">üì¶ Product</span>
                            }
                        </td>
                        <td>@(product.IsService ? "-" : product.StockQuantity.ToString())</td>
                        <td>
                            <a href="/admin/products/edit/@product.Id" class="btn btn-sm btn-warning">
                                <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteProduct(product.Id)">
                                <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<ProductDto>? products;
    private bool updateExisting = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        var query = new GetAllProductsQuery();
        var result = await Mediator.Send(query);
        products = result.OrderBy(x => x.Name).ToList();
    }

    private async Task DeleteProduct(int id)
    {
        if (await JS.InvokeAsync<bool>("confirm", "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?"))
        {
            var command = new DeleteProductCommand(id);
            var result = await Mediator.Send(command);

            if (result.IsSuccess)
            {
                await LoadData();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", $"–û—à–∏–±–∫–∞: {result.Error}");
            }
        }
    }

    private async Task ExportCsv()
    {
        if (products == null || !products.Any())
        {
            await JS.InvokeVoidAsync("alert", "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.");
            return;
        }

        var sb = new System.Text.StringBuilder();
        sb.AppendLine("SKU;Name;Description;Price;UnitId;TaxRateId;IsService;StockQuantity");
        foreach (var p in products)
        {
            var sku = (p.SKU ?? string.Empty).Replace(";", ",");
            var name = (p.Name ?? string.Empty).Replace(";", ",");
            var desc = (p.Description ?? string.Empty).Replace(";", ",");
            var price = p.Price.ToString(System.Globalization.CultureInfo.InvariantCulture);
            var unitId = p.UnitId?.ToString() ?? string.Empty;
            var taxId = p.TaxRateId?.ToString() ?? string.Empty;
            var isService = p.IsService ? "1" : "0";
            var stock = p.StockQuantity.ToString();
            sb.AppendLine($"{sku};{name};{desc};{price};{unitId};{taxId};{isService};{stock}");
        }

        var bytes = System.Text.Encoding.UTF8.GetBytes(sb.ToString());
        var base64 = Convert.ToBase64String(bytes);
        var fileName = $"products-{DateTime.UtcNow:yyyyMMddHHmmss}.csv";
        await JS.InvokeVoidAsync("downloadFile", fileName, "text/csv", base64);
    }

    private async Task ImportCsv(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file == null) return;

            using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();
            if (string.IsNullOrWhiteSpace(content)) return;

            var lines = content.Replace("\r", string.Empty).Split('\n');
            int processed = 0, created = 0, updated = 0;

            foreach (var raw in lines)
            {
                var line = raw.Trim();
                if (string.IsNullOrWhiteSpace(line)) continue;
                if (line.StartsWith("SKU", StringComparison.OrdinalIgnoreCase)) continue; // header

                string[] parts = line.Contains(';') ? line.Split(';') : line.Split(',');
                if (parts.Length < 4) continue; // require at least SKU;Name;Description;Price

                var sku = parts[0].Trim();
                var name = parts[1].Trim();
                var desc = parts[2].Trim();
                var priceStr = parts[3].Trim();

                // optional
                int? unitId = null; if (parts.Length > 4 && int.TryParse(parts[4].Trim(), out var u)) unitId = u;
                int? taxRateId = null; if (parts.Length > 5 && int.TryParse(parts[5].Trim(), out var t)) taxRateId = t;
                bool isService = false; if (parts.Length > 6) isService = parts[6].Trim() == "1" || parts[6].Trim().Equals("true", StringComparison.OrdinalIgnoreCase);
                int stock = 0; if (parts.Length > 7 && int.TryParse(parts[7].Trim(), out var s)) stock = s;

                if (!decimal.TryParse(priceStr, System.Globalization.NumberStyles.Float, System.Globalization.CultureInfo.InvariantCulture, out var price))
                {
                    // try RU/DE cultures
                    if (!decimal.TryParse(priceStr, System.Globalization.NumberStyles.Float, new System.Globalization.CultureInfo("ru-RU"), out price))
                        decimal.TryParse(priceStr, System.Globalization.NumberStyles.Float, new System.Globalization.CultureInfo("de-DE"), out price);
                }

                if (updateExisting)
                {
                    // Try find existing by SKU in loaded list first
                    var existing = products?.FirstOrDefault(p => string.Equals(p.SKU ?? string.Empty, sku, StringComparison.OrdinalIgnoreCase));
                    if (existing != null)
                    {
                        var cmd = new UpdateProductCommand
                        {
                            Id = existing.Id,
                            Name = name,
                            Description = desc,
                            SKU = sku,
                            Price = price,
                            UnitId = unitId,
                            TaxRateId = taxRateId,
                            IsService = isService,
                            StockQuantity = stock
                        };
                        var res = await Mediator.Send(cmd);
                        if (res.IsSuccess)
                        {
                            updated++;
                            processed++;
                        }
                        else
                        {
                            await JS.InvokeVoidAsync("console.warn", $"Update failed: {res.Error}");
                        }
                        continue;
                    }
                }

                var create = new CreateProductCommand
                {
                    Name = name,
                    Description = desc,
                    SKU = sku,
                    Price = price,
                    UnitId = unitId,
                    TaxRateId = taxRateId,
                    IsService = isService,
                    StockQuantity = stock
                };
                var createdRes = await Mediator.Send(create);
                if (createdRes.IsSuccess)
                {
                    created++;
                    processed++;
                }
                else
                {
                    await JS.InvokeVoidAsync("console.warn", $"Create failed: {createdRes.Error}");
                }
            }

            await LoadData();
            await JS.InvokeVoidAsync("alert", $"–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {processed}, —Å–æ–∑–¥–∞–Ω–æ: {created}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: {updated}.");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {ex.Message}");
        }
    }
}
