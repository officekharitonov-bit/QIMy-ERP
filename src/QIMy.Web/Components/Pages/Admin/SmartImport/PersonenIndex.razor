@page "/Admin/SmartImport/PersonenIndex"
@rendermode InteractiveServer
@using QIMy.Core.DTOs
@using QIMy.Core.Enums
@using MediatR
@using QIMy.Application.Clients.Commands.ImportClients
@using QIMy.Application.Suppliers.Commands.ImportSuppliers
@using Microsoft.AspNetCore.Components.Forms
@using QIMy.Web.Services
@using QIMy.AI.Services
@inject IMediator Mediator
@inject NavigationManager NavigationManager
@inject ILogger<PersonenIndex> Logger
@inject BusinessContext BusinessCtx
@inject IAiColumnMappingService AiColumnMapping
@inject IAiDuplicateDetectionService AiDuplicateDetection

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-magic me-2"></i>ü§ñ Smart Import - Personenindex</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/Admin/SmartImport">Smart Import</a></li>
                    <li class="breadcrumb-item active">Personenindex</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Step 1: Configuration -->
    @if (currentStep == ImportStep.Configuration)
    {
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">–®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–º–ø–æ—Ä—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-lightbulb me-2"></i>
                            <strong>ü§ñ AI-Enhanced Smart Import</strong>
                            <ul class="mb-0">
                                <li>‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ (Windows-1252/UTF-8)</li>
                                <li>‚úÖ AI-–º–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ (60+ –∞–ª–∏–∞—Å–æ–≤ DE/EN)</li>
                                <li>‚úÖ –£–º–Ω–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (Fuzzy matching)</li>
                                <li>‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –Ω–æ–º–µ—Ä–æ–≤</li>
                            </ul>
                        </div>

                        <!-- Entity Type Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">–¢–∏–ø –∏–º–ø–æ—Ä—Ç–∞:</label>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="card @(entityType == EntityType.Client ? "border-primary" : "")" 
                                         style="cursor: pointer;"
                                         @onclick="() => SelectEntityType(EntityType.Client)">
                                        <div class="card-body text-center">
                                            <i class="bi bi-people fs-1 @(entityType == EntityType.Client ? "text-primary" : "text-muted")"></i>
                                            <h5 class="mt-2">–ö–ª–∏–µ–Ω—Ç—ã (Kunden)</h5>
                                            <small class="text-muted">–ü–æ–ª—É—á–∞—Ç–µ–ª–∏ —Å—á–µ—Ç–æ–≤ AR</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card @(entityType == EntityType.Supplier ? "border-info" : "")" 
                                         style="cursor: pointer;"
                                         @onclick="() => SelectEntityType(EntityType.Supplier)">
                                        <div class="card-body text-center">
                                            <i class="bi bi-building fs-1 @(entityType == EntityType.Supplier ? "text-info" : "text-muted")"></i>
                                            <h5 class="mt-2">–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ (Lieferanten)</h5>
                                            <small class="text-muted">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏ —Å—á–µ—Ç–æ–≤ ER</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card @(entityType == EntityType.All ? "border-success" : "")" 
                                         style="cursor: pointer;"
                                         @onclick="() => SelectEntityType(EntityType.All)">
                                        <div class="card-body text-center">
                                            <i class="bi bi-globe2 fs-1 @(entityType == EntityType.All ? "text-success" : "text-muted")"></i>
                                            <h5 class="mt-2">–í—Å–µ (Kunden + Lieferanten)</h5>
                                            <small class="text-muted">–ò–º–ø–æ—Ä—Ç –ø–æ –∫–æ–¥—É: 200k-399k</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Area Selection -->
                        @if (entityType != EntityType.None && entityType != EntityType.All)
                        {
                            <div class="mb-4">
                                <label class="form-label fw-bold">–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å:</label>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="card @(selectedArea == AreaSelection.Inland ? "border-success" : "")" 
                                             style="cursor: pointer;"
                                             @onclick="() => SelectArea(AreaSelection.Inland)">
                                            <div class="card-body text-center">
                                                <i class="bi bi-flag-fill fs-2 @(selectedArea == AreaSelection.Inland ? "text-success" : "text-muted")"></i>
                                                <h6 class="mt-2">üá¶üáπ √ñsterreich</h6>
                                                <small class="text-muted">
                                                    @if (entityType == EntityType.Client)
                                                    {
                                                        <span>200000-229999</span>
                                                    }
                                                    else
                                                    {
                                                        <span>300000-329999</span>
                                                    }
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card @(selectedArea == AreaSelection.EU ? "border-primary" : "")" 
                                             style="cursor: pointer;"
                                             @onclick="() => SelectArea(AreaSelection.EU)">
                                            <div class="card-body text-center">
                                                <i class="bi bi-stars fs-2 @(selectedArea == AreaSelection.EU ? "text-primary" : "text-muted")"></i>
                                                <h6 class="mt-2">üá™üá∫ EU</h6>
                                                <small class="text-muted">
                                                    @if (entityType == EntityType.Client)
                                                    {
                                                        <span>230000-259999</span>
                                                    }
                                                    else
                                                    {
                                                        <span>330000-359999</span>
                                                    }
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card @(selectedArea == AreaSelection.ThirdCountry ? "border-warning" : "")" 
                                             style="cursor: pointer;"
                                             @onclick="() => SelectArea(AreaSelection.ThirdCountry)">
                                            <div class="card-body text-center">
                                                <i class="bi bi-globe fs-2 @(selectedArea == AreaSelection.ThirdCountry ? "text-warning" : "text-muted")"></i>
                                                <h6 class="mt-2">üåç Drittland</h6>
                                                <small class="text-muted">
                                                    @if (entityType == EntityType.Client)
                                                    {
                                                        <span>260000-299999</span>
                                                    }
                                                    else
                                                    {
                                                        <span>360000-399999</span>
                                                    }
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Selected Range Display -->
                            @if (selectedArea != AreaSelection.None)
                            {
                                <div class="alert alert-success">
                                    <strong>üìã –í—ã–±—Ä–∞–Ω–æ:</strong>
                                    @entityType.ToString() - @GetAreaName() 
                                    <br/>
                                    <strong>üî¢ –î–∏–∞–ø–∞–∑–æ–Ω –Ω–æ–º–µ—Ä–æ–≤:</strong> @GetNumberRange()
                                </div>
                            }
                        }

                        <!-- File Upload for All option -->
                        @if (entityType == EntityType.All)
                        {
                            <div class="alert alert-info">
                                <strong>üìã –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç:</strong>
                                –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç —Ç–∏–ø –ø–æ –∫–æ–¥—É:
                                <ul class="mb-0">
                                    <li>200000-299999 ‚Üí –ö–ª–∏–µ–Ω—Ç—ã (Kunden)</li>
                                    <li>300000-399999 ‚Üí –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ (Lieferanten)</li>
                                </ul>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">CSV —Ñ–∞–π–ª:</label>
                                <InputFile OnChange="HandleFileSelection" class="form-control" accept=".csv" />
                            </div>
                        }

                        @if (selectedFileName != null)
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-file-earmark-check me-2"></i>
                                –í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: <strong>@selectedFileName</strong>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
                            </div>
                        }

                        @if (entityType != EntityType.None)
                        {
                            <div class="d-flex gap-2 mt-4">
                                <button class="btn btn-info btn-lg" @onclick="ShowPreview"
                                    disabled="@(selectedFile == null || (entityType != EntityType.All && selectedArea == AreaSelection.None) || isLoading)">
                                    @if (isLoading)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-eye me-2"></i>
                                    }
                                    üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                                </button>
                                <button class="btn btn-primary btn-lg" @onclick="StartSmartImport"
                                    disabled="@(selectedFile == null || (entityType != EntityType.All && selectedArea == AreaSelection.None) || isLoading)">
                                    @if (isLoading)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-magic me-2"></i>
                                    }
                                    ü§ñ Smart Import starten
                                </button>
                                <a href="/Admin/SmartImport" class="btn btn-secondary btn-lg">
                                    <i class="bi bi-arrow-left me-2"></i>–ù–∞–∑–∞–¥
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm bg-light">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">üí° –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h6>
                    </div>
                    <div class="card-body">
                        <h6 class="text-primary">–®–∞–≥ 1: –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</h6>
                        <ul class="small">
                            <li><strong>–ö–ª–∏–µ–Ω—Ç—ã</strong> - –µ—Å–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π (AR)</li>
                            <li><strong>–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏</strong> - –µ—Å–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç–µ –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ (ER)</li>
                        </ul>

                        <h6 class="text-primary mt-3">–®–∞–≥ 2: –í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å</h6>
                        <ul class="small">
                            <li><strong>üá¶üáπ √ñsterreich</strong> - –∞–≤—Å—Ç—Ä–∏–π—Å–∫–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</li>
                            <li><strong>üá™üá∫ EU</strong> - –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ –ï–°</li>
                            <li><strong>üåç Drittland</strong> - —Ç—Ä–µ—Ç—å–∏ —Å—Ç—Ä–∞–Ω—ã</li>
                        </ul>

                        <h6 class="text-primary mt-3">–®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV</h6>
                        <ul class="small">
                            <li>–§–æ—Ä–º–∞—Ç: BMD Personenindex</li>
                            <li>–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: ; (semicolon)</li>
                            <li>–ö–æ–¥–∏—Ä–æ–≤–∫–∞: auto-detect</li>
                        </ul>

                        <div class="alert alert-warning mt-3 small">
                            <strong>‚ö†Ô∏è –í–∞–∂–Ω–æ:</strong> –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Step 1.5: Preview -->
    @if (currentStep == ImportStep.Preview && previewRecords != null)
    {
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-eye me-2"></i>üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–º–ø–æ—Ä—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-body text-center">
                                        <h3 class="text-success">@previewClientsCount</h3>
                                        <p class="mb-0">üë• –ö–ª–∏–µ–Ω—Ç–æ–≤ (Kunden)</p>
                                        <small class="text-muted">–î–∏–∞–ø–∞–∑–æ–Ω: @GetNumberRange()</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-body text-center">
                                        <h3 class="text-primary">@previewSuppliersCount</h3>
                                        <p class="mb-0">üè≠ –ü–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (Lieferanten)</p>
                                        <small class="text-muted">–ë—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã –≤ —ç—Ç–æ–º –∏–º–ø–æ—Ä—Ç–µ</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>–ö–∞–∫ QIMy –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø:</strong> 
                            –í —Ä–µ–∂–∏–º–µ –∏–º–ø–æ—Ä—Ç–∞ <strong>@entityType.ToString()</strong> –±—É–¥—É—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ 
                            –∏–∑ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ <strong>@GetNumberRange()</strong>. –û—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã.
                        </div>

                        <h6 class="mb-3">üìã –ó–∞–ø–∏—Å–∏ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ (–ø–µ—Ä–≤—ã–µ 20):</h6>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-striped table-hover">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>–ö–æ–¥</th>
                                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</th>
                                        <th>–¢–∏–ø</th>
                                        <th>–û–±–ª–∞—Å—Ç—å</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var record in previewRecords.Take(20))
                                    {
                                        var willImport = (entityType == EntityType.Client && record.Type == "Client") ||
                                                        (entityType == EntityType.Supplier && record.Type == "Supplier");
                                        <tr class="@(willImport ? "table-success" : "table-warning")">
                                            <td><strong>@record.Code</strong></td>
                                            <td>@record.CompanyName</td>
                                            <td>
                                                @if (record.Type == "Client")
                                                {
                                                    <span class="badge bg-success">üë• –ö–ª–∏–µ–Ω—Ç</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-primary">üè≠ –ü–æ—Å—Ç–∞–≤—â–∏–∫</span>
                                                }
                                            </td>
                                            <td>@record.Area</td>
                                            <td>
                                                @if (willImport)
                                                {
                                                    <span class="badge bg-success">‚úÖ –ò–º–ø–æ—Ä—Ç</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        @if (previewRecords.Count > 20)
                        {
                            <div class="alert alert-secondary mt-3">
                                <i class="bi bi-three-dots me-2"></i>
                                –ò –µ—â—ë @(previewRecords.Count - 20) –∑–∞–ø–∏—Å–µ–π...
                            </div>
                        }

                        <div class="d-flex gap-2 mt-4">
                            <button class="btn btn-success btn-lg" @onclick="StartSmartImport" disabled="@isLoading">
                                <i class="bi bi-check-circle me-2"></i>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button class="btn btn-secondary btn-lg" @onclick="BackToConfiguration">
                                <i class="bi bi-arrow-left me-2"></i>–ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Step 2: Results -->
    @if (currentStep == ImportStep.Completed)
    {
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-check-circle me-2"></i>Smart Import –∑–∞–≤–µ—Ä—à—ë–Ω</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <h5>‚úÖ –ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!</h5>
                            <p class="mb-0">
                                <strong>–¢–∏–ø:</strong> @entityType.ToString() <br/>
                                <strong>–û–±–ª–∞—Å—Ç—å:</strong> @GetAreaName() <br/>
                                <strong>–î–∏–∞–ø–∞–∑–æ–Ω:</strong> @GetNumberRange()
                            </p>
                        </div>

                        @if (entityType == EntityType.Client && clientResult != null)
                        {
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <h6 class="text-primary"><i class="bi bi-people me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</h6>
                                    <table class="table table-sm mb-0">
                                        <tr>
                                            <td>üìä –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫:</td>
                                            <td class="text-end"><strong>@clientResult.TotalRows</strong></td>
                                        </tr>
                                        <tr class="table-success">
                                            <td>‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ:</td>
                                            <td class="text-end"><strong>@clientResult.SuccessCount</strong></td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td>‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ (–¥—É–±–ª–∏–∫–∞—Ç—ã):</td>
                                            <td class="text-end"><strong>@clientResult.SkippedCount</strong></td>
                                        </tr>
                                        <tr class="table-danger">
                                            <td>‚ùå –û—à–∏–±–æ–∫:</td>
                                            <td class="text-end"><strong>@clientResult.ErrorCount</strong></td>
                                        </tr>
                                        <tr>
                                            <td>‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</td>
                                            <td class="text-end"><strong>@clientResult.Duration.TotalSeconds.ToString("F1")s</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            @if (clientResult.Errors.Any())
                            {
                                <div class="alert alert-warning">
                                    <h6>‚ö†Ô∏è –û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞:</h6>
                                    <ul class="mb-0">
                                        @foreach (var error in clientResult.Errors.Take(10))
                                        {
                                            <li><strong>–°—Ç—Ä–æ–∫–∞ @error.RowNumber:</strong> @error.CompanyName - @error.ErrorMessage</li>
                                        }
                                    </ul>
                                    @if (clientResult.Errors.Count > 10)
                                    {
                                        <small class="text-muted">... –∏ –µ—â—ë @(clientResult.Errors.Count - 10) –æ—à–∏–±–æ–∫</small>
                                    }
                                </div>
                            }
                        }

                        @if (entityType == EntityType.Supplier && supplierResult != null)
                        {
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <h6 class="text-info"><i class="bi bi-building me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</h6>
                                    <table class="table table-sm mb-0">
                                        <tr>
                                            <td>üìä –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫:</td>
                                            <td class="text-end"><strong>@supplierResult.TotalRows</strong></td>
                                        </tr>
                                        <tr class="table-success">
                                            <td>‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ:</td>
                                            <td class="text-end"><strong>@supplierResult.SuccessCount</strong></td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td>‚è≠Ô∏è –î—É–±–ª–∏–∫–∞—Ç–æ–≤:</td>
                                            <td class="text-end"><strong>@supplierResult.DuplicateCount</strong></td>
                                        </tr>
                                        <tr class="table-danger">
                                            <td>‚ùå –û—à–∏–±–æ–∫:</td>
                                            <td class="text-end"><strong>@supplierResult.FailureCount</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            @if (supplierResult.Errors.Any())
                            {
                                <div class="alert alert-warning">
                                    <h6>‚ö†Ô∏è –û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞:</h6>
                                    <ul class="mb-0">
                                        @foreach (var error in supplierResult.Errors.Take(10))
                                        {
                                            <li><strong>–°—Ç—Ä–æ–∫–∞ @error.RowNumber:</strong> @error.CompanyName - @error.ErrorMessage</li>
                                        }
                                    </ul>
                                    @if (supplierResult.Errors.Count > 10)
                                    {
                                        <small class="text-muted">... –∏ –µ—â—ë @(supplierResult.Errors.Count - 10) –æ—à–∏–±–æ–∫</small>
                                    }
                                </div>
                            }
                        }

                        <div class="d-flex gap-2 mt-4">
                            @if (entityType == EntityType.Client)
                            {
                                <a href="/AR/Clients" class="btn btn-primary">
                                    <i class="bi bi-people me-2"></i>–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–ª–∏–µ–Ω—Ç–∞–º
                                </a>
                            }
                            @if (entityType == EntityType.Supplier)
                            {
                                <a href="/ER/Suppliers" class="btn btn-info">
                                    <i class="bi bi-building me-2"></i>–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º
                                </a>
                            }
                            <button class="btn btn-secondary" @onclick="Reset">
                                <i class="bi bi-arrow-clockwise me-2"></i>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private enum ImportStep
    {
        Configuration,
        Preview,
        Processing,
        Completed
    }

    private enum EntityType
    {
        None,
        Client,
        Supplier,
        All
    }

    private enum AreaSelection
    {
        None,
        Inland,
        EU,
        ThirdCountry
    }

    private ImportStep currentStep = ImportStep.Configuration;
    private EntityType entityType = EntityType.None;
    private AreaSelection selectedArea = AreaSelection.None;
    
    private IBrowserFile? selectedFile;
    private string? selectedFileName;
    private byte[]? fileContent; // Store file content in memory
    private string? errorMessage;
    private bool isLoading = false;

    private ImportResult? clientResult;
    private Application.Suppliers.Commands.ImportSuppliers.ImportSuppliersResult? supplierResult;
    
    // Preview data
    private List<PreviewRecord>? previewRecords;
    private int previewClientsCount;
    private int previewSuppliersCount;

    private class PreviewRecord
    {
        public int Code { get; set; }
        public string CompanyName { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty; // "Client" or "Supplier"
        public string Area { get; set; } = string.Empty;
    }

    private void SelectEntityType(EntityType type)
    {
        entityType = type;
        selectedArea = AreaSelection.None; // Reset area when changing type
        errorMessage = null;
        StateHasChanged();
    }

    private void SelectArea(AreaSelection area)
    {
        selectedArea = area;
        errorMessage = null;
        StateHasChanged();
    }

    private string GetAreaName()
    {
        return selectedArea switch
        {
            AreaSelection.Inland => "üá¶üáπ √ñsterreich (Inland)",
            AreaSelection.EU => "üá™üá∫ Europ√§ische Union",
            AreaSelection.ThirdCountry => "üåç Drittland",
            _ => "Nicht ausgew√§hlt"
        };
    }

    private string GetNumberRange()
    {
        if (entityType == EntityType.Client)
        {
            return selectedArea switch
            {
                AreaSelection.Inland => "200000-229999",
                AreaSelection.EU => "230000-259999",
                AreaSelection.ThirdCountry => "260000-299999",
                _ => "Nicht definiert"
            };
        }
        else if (entityType == EntityType.Supplier)
        {
            return selectedArea switch
            {
                AreaSelection.Inland => "300000-329999",
                AreaSelection.EU => "330000-359999",
                AreaSelection.ThirdCountry => "360000-399999",
                _ => "Nicht definiert"
            };
        }
        return "Nicht definiert";
    }

    private (int start, int end) GetCodeRange()
    {
        if (entityType == EntityType.Client)
        {
            return selectedArea switch
            {
                AreaSelection.Inland => (200000, 229999),
                AreaSelection.EU => (230000, 259999),
                AreaSelection.ThirdCountry => (260000, 299999),
                _ => (0, 0)
            };
        }
        else if (entityType == EntityType.Supplier)
        {
            return selectedArea switch
            {
                AreaSelection.Inland => (300000, 329999),
                AreaSelection.EU => (330000, 359999),
                AreaSelection.ThirdCountry => (360000, 399999),
                _ => (0, 0)
            };
        }
        return (0, 0);
    }

    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        selectedFileName = e.File.Name;
        errorMessage = null;
        
        // Read file into memory immediately
        try
        {
            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            fileContent = memoryStream.ToArray();
            Logger.LogInformation("üìÅ File loaded into memory: {Size} bytes", fileContent.Length);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error reading file");
            errorMessage = $"Fehler beim Lesen der Datei: {ex.Message}";
            fileContent = null;
        }
        
        StateHasChanged();
    }

    private void BackToConfiguration()
    {
        currentStep = ImportStep.Configuration;
        previewRecords = null;
    }

    private async Task ShowPreview()
    {
        if (fileContent == null || (entityType != EntityType.All && selectedArea == AreaSelection.None))
        {
            errorMessage = "Bitte w√§hlen Sie Typ, Bereich und Datei aus.";
            return;
        }

        isLoading = true;
        errorMessage = null;

        try
        {
            using var memoryStream = new MemoryStream(fileContent);
            memoryStream.Position = 0;

            // Read CSV
            using var reader = new StreamReader(memoryStream, System.Text.Encoding.GetEncoding("windows-1252"));
            var csvContent = await reader.ReadToEndAsync();
            var lines = csvContent.Split('\n').Where(l => !string.IsNullOrWhiteSpace(l)).ToList();

            Logger.LogInformation("üìã Preview: {LineCount} lines found", lines.Count);

            previewRecords = new List<PreviewRecord>();
            previewClientsCount = 0;
            previewSuppliersCount = 0;

            // Skip header
            for (int i = 1; i < lines.Count; i++)
            {
                var line = lines[i];
                var columns = line.Split(';');
                
                if (columns.Length < 2) continue;

                // Try to parse code from SECOND column (Kto-Nr)
                if (int.TryParse(columns[1].Trim(), out int code))
                {
                    var companyName = columns.Length > 2 ? columns[2].Trim() : "N/A";
                    
                    // Determine type based on code range
                    string type;
                    string area;
                    
                    if (code >= 200000 && code <= 299999)
                    {
                        type = "Client";
                        previewClientsCount++;
                        
                        if (code >= 200000 && code <= 229999) area = "üá¶üáπ Inland";
                        else if (code >= 230000 && code <= 259999) area = "üá™üá∫ EU";
                        else area = "üåç Drittland";
                    }
                    else if (code >= 300000 && code <= 399999)
                    {
                        type = "Supplier";
                        previewSuppliersCount++;
                        
                        if (code >= 300000 && code <= 329999) area = "üá¶üáπ Inland";
                        else if (code >= 330000 && code <= 359999) area = "üá™üá∫ EU";
                        else area = "üåç Drittland";
                    }
                    else
                    {
                        type = "Unknown";
                        area = "Unknown";
                    }

                    previewRecords.Add(new PreviewRecord
                    {
                        Code = code,
                        CompanyName = companyName,
                        Type = type,
                        Area = area
                    });
                }
            }

            Logger.LogInformation("üìä Preview stats: {Clients} clients, {Suppliers} suppliers", 
                previewClientsCount, previewSuppliersCount);

            currentStep = ImportStep.Preview;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Preview error");
            errorMessage = $"–û—à–∏–±–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task StartSmartImport()
    {
        if (fileContent == null || (entityType != EntityType.All && selectedArea == AreaSelection.None))
        {
            errorMessage = "Bitte w√§hlen Sie Typ, Bereich und Datei aus.";
            return;
        }

        isLoading = true;
        errorMessage = null;
        currentStep = ImportStep.Processing;

        try
        {
            if (entityType == EntityType.All)
            {
                // Import both Clients and Suppliers
                Logger.LogInformation("ü§ñ Starting Smart Import: Type=All (Clients + Suppliers)");
                
                // Import Clients (200000-299999) - create NEW MemoryStream
                using (var clientStream = new MemoryStream(fileContent))
                {
                    clientStream.Position = 0;
                    var clientCommand = new ImportClientsCommand
                    {
                        FileStream = clientStream,
                        SkipErrors = true,
                        BusinessId = BusinessCtx.CurrentBusinessId
                    };

                    clientResult = await Mediator.Send(clientCommand);
                    Logger.LogInformation("‚úÖ Clients import completed: {Success} success, {Errors} errors, {Skipped} skipped",
                        clientResult.SuccessCount, clientResult.ErrorCount, clientResult.SkippedCount);
                }

                // Import Suppliers (300000-399999) - create NEW MemoryStream
                using (var supplierStream = new MemoryStream(fileContent))
                {
                    supplierStream.Position = 0;
                    var supplierCommand = new ImportSuppliersCommand
                    {
                        FileStream = supplierStream,
                        FileName = selectedFileName ?? "import.csv",
                        BusinessId = BusinessCtx.CurrentBusinessId ?? 0
                    };

                    var supplierResultWrapper = await Mediator.Send(supplierCommand);
                    
                    if (supplierResultWrapper.IsSuccess && supplierResultWrapper.Value != null)
                    {
                        supplierResult = supplierResultWrapper.Value;
                        Logger.LogInformation("‚úÖ Suppliers import completed: {Success} success, {Errors} errors",
                            supplierResult.SuccessCount, supplierResult.FailureCount);
                    }
                }
            }
            else
            {
                var (startCode, endCode) = GetCodeRange();
                
                Logger.LogInformation("ü§ñ Starting Smart Import: Type={EntityType}, Area={Area}, Range={Start}-{End}",
                    entityType, selectedArea, startCode, endCode);

                if (entityType == EntityType.Client)
                {
                    // Import Clients
                    using (var clientStream = new MemoryStream(fileContent))
                    {
                        clientStream.Position = 0;
                        var command = new ImportClientsCommand
                        {
                            FileStream = clientStream,
                            SkipErrors = true,
                            BusinessId = BusinessCtx.CurrentBusinessId
                        };

                        clientResult = await Mediator.Send(command);
                        
                        Logger.LogInformation("‚úÖ Clients import completed: {Success} success, {Errors} errors, {Skipped} skipped",
                            clientResult.SuccessCount, clientResult.ErrorCount, clientResult.SkippedCount);
                    }
                }
                else if (entityType == EntityType.Supplier)
                {
                    // Import Suppliers
                    using (var supplierStream = new MemoryStream(fileContent))
                    {
                        supplierStream.Position = 0;
                        var command = new ImportSuppliersCommand
                        {
                            FileStream = supplierStream,
                            FileName = selectedFileName ?? "import.csv",
                            BusinessId = BusinessCtx.CurrentBusinessId ?? 0
                        };

                        var result = await Mediator.Send(command);
                    
                        if (result.IsSuccess && result.Value != null)
                        {
                            supplierResult = result.Value;
                            Logger.LogInformation("‚úÖ Suppliers import completed: {Success} success, {Errors} errors",
                                supplierResult.SuccessCount, supplierResult.FailureCount);
                        }
                        else
                        {
                            Logger.LogError("‚ùå Supplier import failed: {Error}", result.Error);
                            supplierResult = new Application.Suppliers.Commands.ImportSuppliers.ImportSuppliersResult
                            {
                                TotalRows = 0,
                                SuccessCount = 0,
                                FailureCount = 1,
                                Errors = new List<Application.Suppliers.Commands.ImportSuppliers.ImportError>
                                {
                                    new() { ErrorMessage = result.Error ?? "Unknown error" }
                                }
                            };
                        }
                    }
                }
            }

            currentStep = ImportStep.Completed;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error during Smart Import");
            errorMessage = $"Fehler beim Import: {ex.Message}";
            currentStep = ImportStep.Configuration;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void Reset()
    {
        currentStep = ImportStep.Configuration;
        entityType = EntityType.None;
        selectedArea = AreaSelection.None;
        selectedFile = null;
        selectedFileName = null;
        clientResult = null;
        supplierResult = null;
        errorMessage = null;
        previewRecords = null;
        previewClientsCount = 0;
        previewSuppliersCount = 0;
    }
}
